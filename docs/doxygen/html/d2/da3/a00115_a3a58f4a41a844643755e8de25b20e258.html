<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<title>gcm: gcm_imagen_copiar</title>

<link href="../../tabs.css" rel="stylesheet" type="text/css"/>
<link href="../../doxygen.css" rel="stylesheet" type="text/css" />

<link href="../../search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../jquery.js"></script>
<script type="text/javascript" src="../../search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() {
    if ($('.searchresults').length > 0) { searchBox.DOMSearchField().focus(); }
  });
</script>
<link rel="search" href="../../search-opensearch.php?v=opensearch.xml" type="application/opensearchdescription+xml" title="gcm"/>

</head>
<body>
<div id="top"><!-- do not remove this div! -->


<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  
  
  <td style="padding-left: 0.5em;">
   <div id="projectname">gcm
   &#160;<span id="projectnumber">3</span>
   </div>
   
  </td>
  
  
  
 </tr>
 </tbody>
</table>
</div>

<!-- Generado por Doxygen 1.8.0 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "../../search",false,'Buscar');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="../../index.html"><span>Página&#160;principal</span></a></li>
      <li><a href="../../pages.html"><span>Páginas&#160;relacionadas</span></a></li>
      <li><a href="../../modules.html"><span>Módulos</span></a></li>
      <li><a href="../../namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="../../annotated.html"><span>Estructuras&#160;de&#160;Datos</span></a></li>
      <li><a href="../../files.html"><span>Archivos</span></a></li>
      <li><a href="../../dirs.html"><span>Directorios</span></a></li>
      <li><a href="../../examples.html"><span>Ejemplos</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
          <div class="left">
            <form id="FSearchBox" action="../../search.php" method="get">
              <img id="MSearchSelect" src="../../search/mag.png" alt=""/>
              <input type="text" id="MSearchField" name="query" value="Buscar" size="20" accesskey="S" 
                     onfocus="searchBox.OnSearchFieldFocus(true)" 
                     onblur="searchBox.OnSearchFieldFocus(false)"/>
            </form>
          </div><div class="right"></div>
        </div>
      </li>
    </ul>
  </div>
  <div id="nav-path" class="navpath">
    <ul>
      <li class="navelem"><a class="el" href="../../d2/da3/a00115.html">gcm_imagen.php</a>      </li>
    </ul>
  </div>
</div>
<div class="contents">
<table cellspacing="0" cellpadding="0" border="0">
  <tr>
   <td valign="top">
      <div class="navtab">
        <table>
          <tr><td class="navtab"><a class="qindex" href="../../d2/da3/a00115_ab5f9ba0fac0522058d86b675faae5227.html#ab5f9ba0fac0522058d86b675faae5227">gcm_borrarImagen</a></td></tr>
          <tr><td class="navtab"><a class="qindexHL" href="../../d2/da3/a00115_a3a58f4a41a844643755e8de25b20e258.html#a3a58f4a41a844643755e8de25b20e258">gcm_imagen_copiar</a></td></tr>
          <tr><td class="navtab"><a class="qindex" href="../../d2/da3/a00115_a064bd0e7f3725fa21b98f3e1b51acad0.html#a064bd0e7f3725fa21b98f3e1b51acad0">gcm_listaImagenes</a></td></tr>
          <tr><td class="navtab"><a class="qindex" href="../../d2/da3/a00115_a750c9cb388af8cd4ebe889904485230c.html#a750c9cb388af8cd4ebe889904485230c">gcm_verImagenes</a></td></tr>
          <tr><td class="navtab"><a class="qindex" href="../../d2/da3/a00115_a3cd6fd081fb056bbbb253b164da2c8a4.html#a3cd6fd081fb056bbbb253b164da2c8a4">generarImagen</a></td></tr>
          <tr><td class="navtab"><a class="qindex" href="../../d2/da3/a00115_a62ceeb6414f8bfd5efc48fd5ca840ab5.html#a62ceeb6414f8bfd5efc48fd5ca840ab5">getfilesize</a></td></tr>
        </table>
      </div>
   </td>
   <td valign="top" class="mempage">
<a class="anchor" id="a3a58f4a41a844643755e8de25b20e258"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="../../d2/da3/a00115_a3a58f4a41a844643755e8de25b20e258.html#a3a58f4a41a844643755e8de25b20e258">gcm_imagen_copiar</a> </td>
          <td>(</td>
          <td class="paramtype">$&#160;</td>
          <td class="paramname"><em>imagen</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">$&#160;</td>
          <td class="paramname"><em>destino</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">$&#160;</td>
          <td class="paramname"><em>imagenAlto</em> = <code>'0'</code>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">$&#160;</td>
          <td class="paramname"><em>imagenAncho</em> = <code>'0'</code>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">$&#160;</td>
          <td class="paramname"><em>miniatura</em> = <code>'no'</code>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">$&#160;</td>
          <td class="paramname"><em>miniaturaAlto</em> = <code>'0'</code>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">$&#160;</td>
          <td class="paramname"><em>miniaturaAncho</em> = <code>'0'</code>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Copiar imágen a una ubicación. </p>
<p>Esta función esta pensada para recoger la imágen del directorio temporal despues de ser subida desde un formulario y copiarla al directorio de destino indicado o moverla con un nombre diferente</p>
<dl class="todo"><dt><b><a class="el" href="../../df/df1/a00357.html#_todo000016">Tareas pendientes:</a></b></dt><dd>Se podra indicar si queremos una miniatura que en caso de ser afirmativo la crearemos en el subdirectorio con el nombre indicado</dd></dl>
<p>Se podra indicar si queremos una altura o anchura max que en el caso de tener alguno de estos valores definidos, transformaremos la imagen.</p>
<p>Para las miniaturas tambien se puede especificar alto o ancho maximo</p>
<dl class="params"><dt><b>Parámetros:</b></dt><dd>
  <table class="params">
    <tr><td class="paramname">$imagen</td><td>Nombre del campo de formulario con la imagen </td></tr>
    <tr><td class="paramname">$destino</td><td>Carpeta en la que se desea copiar, "/" final incluida </td></tr>
    <tr><td class="paramname">$imagenAlto</td><td>Alto maximo de la imagen, por defecto ninguno. </td></tr>
    <tr><td class="paramname">$imagenAncho</td><td>Ancho maximo de la imagen, por defecto ninguno. </td></tr>
    <tr><td class="paramname">$miniatura</td><td>Si es diferente a no el nombre de la subcarpeta sera el valor de la variable. </td></tr>
    <tr><td class="paramname">$miniaturaAlto</td><td>Alto maximo de la miniatura, por defecto ninguno. </td></tr>
    <tr><td class="paramname">$miniaturaAncho</td><td>Ancho maximo de la miniatura, por defecto ninguno. </td></tr>
  </table>
  </dd>
</dl>

<p>Definición en la línea <a class="el" href="../../d2/da3/a00115_source.html#l00035">35</a> del archivo <a class="el" href="../../d2/da3/a00115_source.html">gcm_imagen.php</a>.</p>

<p>Referenciado por <a class="el" href="../../dc/d5d/a00278_source.html#l00177">Idiomas\administrar()</a>.</p>
<div class="fragment"><pre class="fragment">                                                                                                                                           {

   global $_FILES;

   $imagenFile      = $imagen[<span class="stringliteral">&#39;tmp_name&#39;</span>];
   $imagenName      = $imagen[<span class="stringliteral">&#39;name&#39;</span>];
   $imagenSize      = $imagen[<span class="stringliteral">&#39;size&#39;</span>];
   $imagenType      = $imagen[<span class="stringliteral">&#39;type&#39;</span>];
   $imagenError     = $imagen[<span class="stringliteral">&#39;error&#39;</span>];


   <span class="keywordflow">if</span> ( is_dir($destino) ) { <span class="comment">// Si es un directorio</span>
      $dirFinal = $destino.<span class="stringliteral">&quot;/&quot;</span>;
      $nombreFinal = $dirFinal.$imagenName ;
   } <span class="keywordflow">else</span> { <span class="comment">// Si no lo es se guarda con el nombre pasadp</span>
      $dirFinal = $destino;
      $nombreFinal = $dirFinal;
   }

   <span class="keywordflow">if</span> ( $imagenError == 4 ) {

      $imagenFile      = null;
      $imagenName      = null;
      $imagenSize      = null;
      $imagenType      = null;

      $mens = <span class="stringliteral">&quot;No se subio ningún fichero&quot;</span>;
      registrar(__FILE__,__LINE__,$mens,<span class="stringliteral">&#39;ERROR&#39;</span>);

      <span class="keywordflow">return</span> NULL ;

   }

   <span class="comment">// *** Control de errores</span>

   <span class="keywordflow">if</span> ($imagenError&gt;0){

      <span class="keywordflow">switch</span> ($imagenError){
         <span class="keywordflow">case</span> 1:
            $mens = <span class="stringliteral">&quot;Tamaño excesivo de archivo&quot;</span>;
            registrar(__FILE__,__LINE__,$mens,<span class="stringliteral">&#39;ERROR&#39;</span>);
            echo <span class="stringliteral">&#39;&lt;script&gt;alert(&quot;Tamaño del archivo excesivo\nMax permitido: &#39;</span>.ini_get(<span class="stringliteral">&#39;upload_max_filesize&#39;</span>).<span class="stringliteral">&#39;&quot;);&lt;/script&gt;&#39;</span>;
            <span class="keywordflow">return</span> NULL ;
            <span class="keywordflow">break</span>;
         <span class="keywordflow">case</span> 2:
            $mens = <span class="stringliteral">&quot;Tamaño excesivo de archivo&quot;</span>;
            registrar(__FILE__,__LINE__,$mens,<span class="stringliteral">&#39;ERROR&#39;</span>);
            echo <span class="stringliteral">&#39;&lt;script&gt;alert(&quot;Tamaño del archivo excesivo\nMax permitido: &#39;</span>.ini_get(<span class="stringliteral">&#39;upload_max_filesize&#39;</span>).<span class="stringliteral">&#39;&quot;);&lt;/script&gt;&#39;</span>;
            <span class="keywordflow">return</span> NULL ;
            <span class="keywordflow">break</span>;
         <span class="keywordflow">default</span>:
            $mens = <span class="stringliteral">&quot;Error al subir la imágen&quot;</span>;
            registrar(__FILE__,__LINE__,$mens,<span class="stringliteral">&#39;ERROR&#39;</span>);
            <span class="keywordflow">return</span> NULL ;
            <span class="keywordflow">break</span>;
       }
       $mens = <span class="stringliteral">&quot;Error al subir la imágen&quot;</span>;
       registrar(__FILE__,__LINE__,$mens,<span class="stringliteral">&#39;ERROR&#39;</span>);
       <span class="keywordflow">return</span> NULL ;
   }

   <span class="comment">// *** Control de seguridad</span>
   <span class="keywordflow">if</span> (!is_uploaded_file($imagenFile)){
     $mens = <span class="stringliteral">&quot;Acceso no permitido, posible violación de seguridad&quot;</span>;
     registrar(__FILE__,__LINE__,$mens,<span class="stringliteral">&#39;ERROR&#39;</span>);
     <span class="keywordflow">return</span> NULL ;
   }

   <span class="comment">// Si es un archivo zip lo descomprimimos</span>
   <span class="keywordflow">if</span> ( $imagenType == <span class="stringliteral">&#39;application/zip&#39;</span> ) {

      <span class="comment">// listar archivos incluidos para procesarlos despues</span>
      $zip = zip_open($imagenFile);
      <span class="keywordflow">if</span> ($zip) {
         <span class="keywordflow">while</span> ($zip_entry = zip_read($zip)) {
           $listaZip[]=zip_entry_name($zip_entry);
         }
      zip_close($zip);
      } <span class="keywordflow">else</span> {
         $mens = <span class="stringliteral">&#39;No se pudo abrir el archivo zip: &#39;</span>.$imagenName;
         registrar(__FILE__,__LINE__,$mens,<span class="stringliteral">&#39;ERROR&#39;</span>);
         echo <span class="stringliteral">&#39;&lt;script&gt;alert(\&#39;No se pudo abrir el archivo zip: &#39;</span>.$imagenName.<span class="charliteral">&#39;\&#39;</span>);&lt;/script&gt;<span class="stringliteral">&#39;;</span>
<span class="stringliteral">         return null ;</span>
<span class="stringliteral">      }</span>
<span class="stringliteral"></span>
<span class="stringliteral">      if ( count($listaZip) &lt; 1 ) {</span>
<span class="stringliteral">         $mens = $imagenName.&#39;</span> vacio<span class="stringliteral">&#39;;</span>
<span class="stringliteral">         registrar(__FILE__,__LINE__,$mens,&#39;</span>ERROR<span class="stringliteral">&#39;);</span>
<span class="stringliteral">         echo &#39;</span>&lt;script&gt;alert(\<span class="stringliteral">&#39;Vacio &#39;</span>.$imagenName.<span class="charliteral">&#39;\&#39;</span>);&lt;/script&gt;<span class="stringliteral">&#39;;</span>
<span class="stringliteral">         return null ;</span>
<span class="stringliteral">      }</span>
<span class="stringliteral"></span>
<span class="stringliteral"></span>
<span class="stringliteral">      include(&quot;zip.php&quot;);</span>
<span class="stringliteral">      if ( zip_extract_to($imagenFile,$dirFinal , true) ) {</span>
<span class="stringliteral">         echo &#39;</span>&lt;script&gt;parent.resultadoUpload (\<span class="stringliteral">&#39;0\&#39;, \&#39;&#39;</span>.$imagenName.<span class="charliteral">&#39;\&#39;</span>);&lt;/script&gt;<span class="stringliteral">&#39;;</span>
<span class="stringliteral">      } else {</span>
<span class="stringliteral">         $mens = &#39;</span>Archivo <span class="stringliteral">&#39;.$imagenName.&#39;</span> no se pudo descomprimir<span class="stringliteral">&#39;;</span>
<span class="stringliteral">         registrar(__FILE__,__LINE__,$mens,&#39;</span>ERROR<span class="stringliteral">&#39;);</span>
<span class="stringliteral">         echo &#39;</span>&lt;script&gt;parent.resultadoUpload (\<span class="stringliteral">&#39;4\&#39;, \&#39;No se pudo descomprimir &#39;</span>.$imagenName.<span class="charliteral">&#39;\&#39;</span>);&lt;/script&gt;<span class="stringliteral">&#39;;</span>
<span class="stringliteral">         return NULL ;</span>
<span class="stringliteral">      }</span>
<span class="stringliteral"></span>
<span class="stringliteral">      $num = count($listaZip);</span>
<span class="stringliteral">      echo &quot;gcm_imagen_copiar::Numero de imagenes: &lt;b&gt;$num&lt;/b&gt;&quot;;</span>
<span class="stringliteral">      if ( $num &gt; 0 ) {</span>
<span class="stringliteral">         for ($i=0 ; $i!=$num; $i++) {</span>
<span class="stringliteral">            $imagen = $dirFinal.$listaZip[$i] ;</span>
<span class="stringliteral">            $salida.=$imagen.&#39;</span>\n<span class="stringliteral">&#39;;</span>
<span class="stringliteral"></span>
<span class="stringliteral">            // Generamos imagen</span>
<span class="stringliteral">            generarImagen($imagen, $dirFinal, $imagenAlto, $imagenAncho);</span>
<span class="stringliteral"></span>
<span class="stringliteral">            // Especificar las acciones a realizar.</span>
<span class="stringliteral">            $hacerMiniatura   = NULL;</span>
<span class="stringliteral"></span>
<span class="stringliteral">            if ( $miniatura != &quot;&quot; &amp;&amp; $miniatura != &#39;</span>no<span class="stringliteral">&#39; ) {</span>
<span class="stringliteral">              $hacerMiniatura = TRUE;</span>
<span class="stringliteral">              generarImagen($imagen, $miniatura, $miniaturaAlto, $miniaturaAncho);</span>
<span class="stringliteral">            }</span>
<span class="stringliteral"></span>
<span class="stringliteral">         }</span>
<span class="stringliteral">      }</span>
<span class="stringliteral"></span>
<span class="stringliteral">      echo &#39;</span>&lt;script&gt;parent.resultadoUpload (\<span class="stringliteral">&#39;0\&#39;, \&#39;&#39;</span>.$imagenName.<span class="charliteral">&#39; &#39;</span>.$num.<span class="stringliteral">&#39; imagenes\\n&#39;</span>.$salida.<span class="charliteral">&#39;\&#39;</span>);&lt;/script&gt;<span class="stringliteral">&#39;;</span>
<span class="stringliteral"></span>
<span class="stringliteral">      return TRUE ;</span>
<span class="stringliteral"></span>
<span class="stringliteral">   } else { // Acaba si es un archivo zip</span>
<span class="stringliteral"></span>
<span class="stringliteral">      // Copiar imagen a destino antes de tratar</span>
<span class="stringliteral"></span>
<span class="stringliteral">      if (!copy($imagenFile ,$nombreFinal)) {</span>
<span class="stringliteral">        trigger_error(&#39;</span>Error al copiar imagen [<span class="stringliteral">&#39;.$imagenFile.&#39;</span>] a [<span class="stringliteral">&#39;.$nombreFinal.&#39;</span>]<span class="stringliteral">&#39;, E_USER_ERROR);</span>
<span class="stringliteral">        return NULL ;</span>
<span class="stringliteral">         }</span>
<span class="stringliteral"></span>
<span class="stringliteral">      $imagen = $nombreFinal ;</span>
<span class="stringliteral"></span>
<span class="stringliteral">      // Generamos imagen en el caso de tener Alto o ancho, sino no hace falta</span>
<span class="stringliteral">      if ( $imagenAlto != 0 &amp;&amp; $imagenAncho != 0 ) {</span>
<span class="stringliteral">         generarImagen($imagen, $dirFinal, $imagenAlto, $imagenAncho);</span>
<span class="stringliteral">         }</span>
<span class="stringliteral"></span>
<span class="stringliteral">      // Especificar las acciones a realizar.</span>
<span class="stringliteral">      $hacerMiniatura   = NULL;</span>
<span class="stringliteral"></span>
<span class="stringliteral">      if ( $miniatura != &quot;&quot; &amp;&amp; $miniatura != &#39;</span>no<span class="stringliteral">&#39; ) {</span>
<span class="stringliteral">        $hacerMiniatura = TRUE;</span>
<span class="stringliteral">        generarImagen($imagen, $miniatura, $miniaturaAlto, $miniaturaAncho);</span>
<span class="stringliteral">         }</span>
<span class="stringliteral"></span>
<span class="stringliteral">      return TRUE ;</span>
<span class="stringliteral"></span>
<span class="stringliteral">      } // Acaba sino es un archivo zip</span>
<span class="stringliteral"></span>
<span class="stringliteral">   }</span>
</pre></div>
</div>
</div>
    </td>
  </tr>
</table>
</div><!-- contents -->


<hr class="footer"/><address class="footer"><small>
Generado el Jueves, 22 de Noviembre de 2012 18:21:35 para gcm por &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="../../doxygen.png" alt="doxygen"/>
</a> 1.8.0
</small></address>

</body>
</html>
