<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<title>gcm: Fichero Fuente gcm/modulos/indexador/lib/Indexador.php</title>

<link href="../../tabs.css" rel="stylesheet" type="text/css"/>
<link href="../../doxygen.css" rel="stylesheet" type="text/css" />

<link href="../../search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../jquery.js"></script>
<script type="text/javascript" src="../../search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() {
    if ($('.searchresults').length > 0) { searchBox.DOMSearchField().focus(); }
  });
</script>
<link rel="search" href="../../search-opensearch.php?v=opensearch.xml" type="application/opensearchdescription+xml" title="gcm"/>

</head>
<body>
<div id="top"><!-- do not remove this div! -->


<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  
  
  <td style="padding-left: 0.5em;">
   <div id="projectname">gcm
   &#160;<span id="projectnumber">3</span>
   </div>
   
  </td>
  
  
  
 </tr>
 </tbody>
</table>
</div>

<!-- Generado por Doxygen 1.8.0 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "../../search",false,'Buscar');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="../../index.html"><span>Página&#160;principal</span></a></li>
      <li><a href="../../pages.html"><span>Páginas&#160;relacionadas</span></a></li>
      <li><a href="../../modules.html"><span>Módulos</span></a></li>
      <li><a href="../../namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="../../annotated.html"><span>Estructuras&#160;de&#160;Datos</span></a></li>
      <li class="current"><a href="../../files.html"><span>Archivos</span></a></li>
      <li><a href="../../dirs.html"><span>Directorios</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
          <div class="left">
            <form id="FSearchBox" action="../../search.php" method="get">
              <img id="MSearchSelect" src="../../search/mag.png" alt=""/>
              <input type="text" id="MSearchField" name="query" value="Buscar" size="20" accesskey="S" 
                     onfocus="searchBox.OnSearchFieldFocus(true)" 
                     onblur="searchBox.OnSearchFieldFocus(false)"/>
            </form>
          </div><div class="right"></div>
        </div>
      </li>
    </ul>
  </div>
  <div id="navrow2" class="tabs2">
    <ul class="tablist">
      <li><a href="../../files.html"><span>Lista&#160;de&#160;archivos</span></a></li>
      <li><a href="../../globals.html"><span>Globales</span></a></li>
    </ul>
  </div>
  <div id="nav-path" class="navpath">
    <ul>
      <li class="navelem"><a class="el" href="../../dir_7220247a7eb7348af0158c165feaa73e.html">gcm</a>      </li>
      <li class="navelem"><a class="el" href="../../dir_68a9a62338f056989803ab8fbb9b88d5.html">modulos</a>      </li>
      <li class="navelem"><a class="el" href="../../dir_9b052a3440b154b2392779948b3a8c54.html">indexador</a>      </li>
      <li class="navelem"><a class="el" href="../../dir_5c1b4def06d49ad0ac8710a54fb3478c.html">lib</a>      </li>
    </ul>
  </div>
</div>
<div class="header">
  <div class="headertitle">
<div class="title">Indexador.php</div>  </div>
</div><!--header-->
<div class="contents">
<a href="../../d2/d71/a00309.html">Ir a la documentación de este archivo.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 &lt;?php
<a name="l00002"></a>00002 <span class="comment"></span>
<a name="l00003"></a>00003 <span class="comment">/**</span>
<a name="l00004"></a>00004 <span class="comment"> * @file      Indexador.php</span>
<a name="l00005"></a>00005 <span class="comment"> * @brief     Indexar contenido</span>
<a name="l00006"></a>00006 <span class="comment"> *</span>
<a name="l00007"></a>00007 <span class="comment"> * @author    Eduardo Magrané </span>
<a name="l00008"></a>00008 <span class="comment"> *</span>
<a name="l00009"></a>00009 <span class="comment"> * @internal</span>
<a name="l00010"></a>00010 <span class="comment"> *   Created  04/02/11</span>
<a name="l00011"></a>00011 <span class="comment"> *  Revision  SVN $Id: Indexador.php 651 2012-10-17 09:19:07Z eduardo $</span>
<a name="l00012"></a>00012 <span class="comment"> * Copyright  Copyright (c) 2011, Eduardo Magrané</span>
<a name="l00013"></a>00013 <span class="comment"> *</span>
<a name="l00014"></a>00014 <span class="comment"> * This source code is released for free distribution under the terms of the</span>
<a name="l00015"></a>00015 <span class="comment"> * GNU General Public License as published by the Free Software Foundation.</span>
<a name="l00016"></a>00016 <span class="comment"> */</span>
<a name="l00017"></a>00017 <span class="comment"></span>
<a name="l00018"></a>00018 <span class="comment">/** Módulo Indexador</span>
<a name="l00019"></a>00019 <span class="comment"> *</span>
<a name="l00020"></a>00020 <span class="comment"> * Para tener una base de datos que nos permita:</span>
<a name="l00021"></a>00021 <span class="comment"> *</span>
<a name="l00022"></a>00022 <span class="comment"> * - hacer busquedas.</span>
<a name="l00023"></a>00023 <span class="comment"> * - Presentar ultimos añadidos o modificados</span>
<a name="l00024"></a>00024 <span class="comment"> * - entre otras cosas.</span>
<a name="l00025"></a>00025 <span class="comment"> *</span>
<a name="l00026"></a>00026 <span class="comment"> * @todo Crear módulo para etiquetas</span>
<a name="l00027"></a>00027 <span class="comment"> *</span>
<a name="l00028"></a>00028 <span class="comment"> * @version 0.1</span>
<a name="l00029"></a>00029 <span class="comment"> * </span>
<a name="l00030"></a>00030 <span class="comment"> */</span>
<a name="l00031"></a>00031 
<a name="l00032"></a><a class="code" href="../../d5/df9/a00044.html">00032</a> <span class="keyword">class </span><a class="code" href="../../d5/df9/a00044.html" title="Módulo Indexador.">Indexador</a> <span class="keyword">extends</span> <a class="code" href="../../d4/dca/a00048.html" title="Interface para los módulos.">Modulos</a> {
<a name="l00033"></a>00033 
<a name="l00034"></a><a class="code" href="../../d5/df9/a00044_abd2b45b666af079d421f8e12509c1381.html#abd2b45b666af079d421f8e12509c1381">00034</a>    <span class="keyword">public</span> <a class="code" href="../../d5/df9/a00044_abd2b45b666af079d421f8e12509c1381.html#abd2b45b666af079d421f8e12509c1381" title="Archivos o directorios a descartar.">$descartar</a>;                          <span class="comment">///&lt; Archivos o directorios a descartar</span>
<a name="l00035"></a><a class="code" href="../../d5/df9/a00044_a4e3c68baf5dea2645d178e183207f0de.html#a4e3c68baf5dea2645d178e183207f0de">00035</a> <span class="comment"></span>   <span class="keyword">public</span> <a class="code" href="../../d5/df9/a00044_a4e3c68baf5dea2645d178e183207f0de.html#a4e3c68baf5dea2645d178e183207f0de" title="Tamaño en caracteres de la descripción de los archivos a indexar.">$maxLong</a> = 200;                      <span class="comment">///&lt; Tamaño en caracteres de la descripción de los archivos a indexar</span>
<a name="l00036"></a>00036 <span class="comment"></span>
<a name="l00037"></a>00037    <span class="keyword">private</span> $pdo = NULL;                        <span class="comment">///&lt; Instancia a la base de datos</span>
<a name="l00038"></a>00038 <span class="comment"></span>   <span class="keyword">private</span> $BD  = <span class="stringliteral">&#39;DATOS/proyecto.db&#39;</span>;         <span class="comment">///&lt; Archivo sqlite</span>
<a name="l00039"></a>00039 <span class="comment"></span>   <span class="keyword">private</span> $prefijo = <span class="stringliteral">&#39;&#39;</span>;                      <span class="comment">///&lt; Prefijo para base de datos</span>
<a name="l00040"></a>00040 <span class="comment"></span><span class="comment"></span>
<a name="l00041"></a>00041 <span class="comment">   /**</span>
<a name="l00042"></a>00042 <span class="comment">    * Saber si se presento &#39;últimas entradas&#39; en contenido, en tal caso no se debe</span>
<a name="l00043"></a>00043 <span class="comment">    * presentar en columna</span>
<a name="l00044"></a>00044 <span class="comment">    */</span>
<a name="l00045"></a>00045 
<a name="l00046"></a>00046    <span class="keyword">private</span> $ultimos_en_contenido = FALSE;
<a name="l00047"></a>00047 <span class="comment"></span>
<a name="l00048"></a>00048 <span class="comment">   /** Constructor */</span>
<a name="l00049"></a>00049 
<a name="l00050"></a><a class="code" href="../../d5/df9/a00044_a095c5d389db211932136b53f25f39685.html#a095c5d389db211932136b53f25f39685">00050</a>    <span class="keyword">function</span> <a class="code" href="../../d5/df9/a00044_a095c5d389db211932136b53f25f39685.html#a095c5d389db211932136b53f25f39685" title="Constructor.">__construct</a>() {
<a name="l00051"></a>00051 
<a name="l00052"></a>00052       global <a class="code" href="../../d4/d63/a00082_a19a0c049e76bf73f0a16f04e31cfbe86.html#a19a0c049e76bf73f0a16f04e31cfbe86" title="Instancia de Gcm.">$gcm</a>;
<a name="l00053"></a>00053 
<a name="l00054"></a>00054       <a class="code" href="../../d5/df9/a00044_a095c5d389db211932136b53f25f39685.html#a095c5d389db211932136b53f25f39685" title="Constructor.">parent::__construct</a>();
<a name="l00055"></a>00055 
<a name="l00056"></a>00056       $this-&gt;pdo = $gcm-&gt;pdo_conexion($this-&gt;BD);
<a name="l00057"></a>00057       $this-&gt;prefijo = $gcm-&gt;sufijo;
<a name="l00058"></a>00058 
<a name="l00059"></a>00059       $this-&gt;descartar = $gcm-&gt;config(<span class="stringliteral">&#39;contenidos&#39;</span>,<span class="stringliteral">&#39;descartar&#39;</span>);
<a name="l00060"></a>00060       $this-&gt;maxLong = $this-&gt;<a class="code" href="../../d4/dca/a00048_a841e8831c531eb620a850d7cbbfe1acc.html#a841e8831c531eb620a850d7cbbfe1acc" title="Añadir o modificar elemento de configuración.">config</a>(<span class="stringliteral">&#39;maxLong&#39;</span>);
<a name="l00061"></a>00061 
<a name="l00062"></a>00062       <span class="comment">/* Comprobamos que las tablas sino tenemos que crearlas */</span>
<a name="l00063"></a>00063 
<a name="l00064"></a>00064       <span class="keywordflow">if</span> ( ! <a class="code" href="../../df/d98/a00107_a81b792b5efa477e76c157f1cdb7840a1.html#a81b792b5efa477e76c157f1cdb7840a1" title="Comprobar existencia de tabla.">existe_tabla</a>($this-&gt;pdo, $this-&gt;prefijo.<span class="stringliteral">&#39;etiquetas&#39;</span>) ) {
<a name="l00065"></a>00065 
<a name="l00066"></a>00066          $this-&gt;<a class="code" href="../../d5/df9/a00044_a267bfb8d6746e1d698abef3c25ec162c.html#a267bfb8d6746e1d698abef3c25ec162c" title="Generar tablas.">generar_tablas</a>();
<a name="l00067"></a>00067 
<a name="l00068"></a>00068          }
<a name="l00069"></a>00069 
<a name="l00070"></a>00070       }
<a name="l00071"></a>00071 <span class="comment"></span>
<a name="l00072"></a>00072 <span class="comment">   /**</span>
<a name="l00073"></a>00073 <span class="comment">    * Comprobar funcionamiento</span>
<a name="l00074"></a>00074 <span class="comment">    */</span>
<a name="l00075"></a>00075 
<a name="l00076"></a><a class="code" href="../../d5/df9/a00044_ad69dd4607977cae05ebe19d1ae604fb1.html#ad69dd4607977cae05ebe19d1ae604fb1">00076</a>    <span class="keyword">function</span> <a class="code" href="../../d5/df9/a00044_ad69dd4607977cae05ebe19d1ae604fb1.html#ad69dd4607977cae05ebe19d1ae604fb1" title="Comprobar funcionamiento.">test</a>() {
<a name="l00077"></a>00077 
<a name="l00078"></a>00078       $sql = <span class="stringliteral">&#39;SELECT COUNT(*) FROM &#39;</span>.$this-&gt;prefijo.<span class="stringliteral">&#39;etiquetas&#39;</span>;
<a name="l00079"></a>00079 
<a name="l00080"></a>00080       $this-&gt;<a class="code" href="../../d4/dca/a00048_a73d09724ce888beae9c3fe1d4b57327e.html#a73d09724ce888beae9c3fe1d4b57327e" title="Test de módulos.">ejecuta_test</a>(<span class="stringliteral">&#39;Tablas creadas&#39;</span>, $this-&gt;pdo-&gt;prepare($sql));
<a name="l00081"></a>00081 
<a name="l00082"></a>00082       }
<a name="l00083"></a>00083 <span class="comment"></span>
<a name="l00084"></a>00084 <span class="comment">   /**</span>
<a name="l00085"></a>00085 <span class="comment">    * Generar tablas</span>
<a name="l00086"></a>00086 <span class="comment">    */</span>
<a name="l00087"></a>00087 
<a name="l00088"></a><a class="code" href="../../d5/df9/a00044_a267bfb8d6746e1d698abef3c25ec162c.html#a267bfb8d6746e1d698abef3c25ec162c">00088</a>    <span class="keyword">function</span> <a class="code" href="../../d5/df9/a00044_a267bfb8d6746e1d698abef3c25ec162c.html#a267bfb8d6746e1d698abef3c25ec162c" title="Generar tablas.">generar_tablas</a>() {
<a name="l00089"></a>00089 
<a name="l00090"></a>00090       global <a class="code" href="../../d4/d63/a00082_a19a0c049e76bf73f0a16f04e31cfbe86.html#a19a0c049e76bf73f0a16f04e31cfbe86" title="Instancia de Gcm.">$gcm</a>;
<a name="l00091"></a>00091 
<a name="l00092"></a>00092       registrar(__FILE__,__LINE__,<span class="stringliteral">&#39;Creación de base de datos para indexación&#39;</span>);
<a name="l00093"></a>00093 
<a name="l00094"></a>00094       $driver = $this-&gt;pdo-&gt;getAttribute(constant(<span class="stringliteral">&quot;PDO::ATTR_DRIVER_NAME&quot;</span>));
<a name="l00095"></a>00095 
<a name="l00096"></a>00096       <span class="keywordflow">switch</span>($driver) {
<a name="l00097"></a>00097 
<a name="l00098"></a>00098          <span class="keywordflow">case</span> <span class="stringliteral">&#39;sqlite&#39;</span>:
<a name="l00099"></a>00099 
<a name="l00100"></a>00100             $SQL = <span class="stringliteral">&quot;CREATE TABLE &quot;</span>.$this-&gt;prefijo.<span class="stringliteral">&quot;etiquetas (</span>
<a name="l00101"></a>00101 <span class="stringliteral">                  id INTEGER PRIMARY KEY,</span>
<a name="l00102"></a>00102 <span class="stringliteral">                  nombre CHAR(20) UNIQUE,</span>
<a name="l00103"></a>00103 <span class="stringliteral">                  descripcion VARCHAR(80)</span>
<a name="l00104"></a>00104 <span class="stringliteral">                  )&quot;</span>;
<a name="l00105"></a>00105             $sqlResult = $this-&gt;pdo-&gt;query($SQL);
<a name="l00106"></a>00106 
<a name="l00107"></a>00107             $SQL=<span class="stringliteral">&quot;CREATE TABLE &quot;</span>.$this-&gt;prefijo.<span class="stringliteral">&quot;archivos (</span>
<a name="l00108"></a>00108 <span class="stringliteral">               id INTEGER PRIMARY KEY,</span>
<a name="l00109"></a>00109 <span class="stringliteral">               nombre CHAR(150) ,</span>
<a name="l00110"></a>00110 <span class="stringliteral">               descripcion VARCHAR(&quot;</span>.$this-&gt;maxLong.<span class="stringliteral">&quot;),</span>
<a name="l00111"></a>00111 <span class="stringliteral">               url CHAR(200) UNIQUE,</span>
<a name="l00112"></a>00112 <span class="stringliteral">               fecha_creacion_at TIME NOT NULL DEFAULT CURRENT_TIMESTAMP,</span>
<a name="l00113"></a>00113 <span class="stringliteral">               fecha_actualizacion_in TIME</span>
<a name="l00114"></a>00114 <span class="stringliteral">               )&quot;</span>;
<a name="l00115"></a>00115             $sqlResult = $this-&gt;pdo-&gt;query($SQL);
<a name="l00116"></a>00116 
<a name="l00117"></a>00117             $SQL=<span class="stringliteral">&quot;CREATE TABLE &quot;</span>.$this-&gt;prefijo.<span class="stringliteral">&quot;r_etiqueta_archivo (</span>
<a name="l00118"></a>00118 <span class="stringliteral">               etiquetas_id INTEGER,</span>
<a name="l00119"></a>00119 <span class="stringliteral">               archivos_id INTEGER,</span>
<a name="l00120"></a>00120 <span class="stringliteral">               PRIMARY KEY (etiquetas_id, archivos_id)</span>
<a name="l00121"></a>00121 <span class="stringliteral">               )&quot;</span>;
<a name="l00122"></a>00122             $sqlResult = $this-&gt;pdo-&gt;query($SQL);
<a name="l00123"></a>00123             <span class="keywordflow">break</span>;
<a name="l00124"></a>00124 
<a name="l00125"></a>00125          <span class="keywordflow">case</span> <span class="stringliteral">&#39;mysql&#39;</span>:
<a name="l00126"></a>00126 
<a name="l00127"></a>00127             $SQL = <span class="stringliteral">&quot;CREATE TABLE &quot;</span>.$this-&gt;prefijo.<span class="stringliteral">&quot;etiquetas (</span>
<a name="l00128"></a>00128 <span class="stringliteral">                  id MEDIUMINT NOT NULL AUTO_INCREMENT,</span>
<a name="l00129"></a>00129 <span class="stringliteral">                  nombre CHAR(20) UNIQUE,</span>
<a name="l00130"></a>00130 <span class="stringliteral">                  descripcion VARCHAR(80),</span>
<a name="l00131"></a>00131 <span class="stringliteral">                  PRIMARY KEY (id)</span>
<a name="l00132"></a>00132 <span class="stringliteral">                  )&quot;</span>;
<a name="l00133"></a>00133             $sqlResult = $this-&gt;pdo-&gt;query($SQL);
<a name="l00134"></a>00134 
<a name="l00135"></a>00135             $SQL=<span class="stringliteral">&quot;CREATE TABLE &quot;</span>.$this-&gt;prefijo.<span class="stringliteral">&quot;archivos (</span>
<a name="l00136"></a>00136 <span class="stringliteral">               id MEDIUMINT NOT NULL AUTO_INCREMENT,</span>
<a name="l00137"></a>00137 <span class="stringliteral">               nombre CHAR(150) ,</span>
<a name="l00138"></a>00138 <span class="stringliteral">               descripcion VARCHAR(&quot;</span>.$this-&gt;maxLong.<span class="stringliteral">&quot;),</span>
<a name="l00139"></a>00139 <span class="stringliteral">               url CHAR(200) UNIQUE,</span>
<a name="l00140"></a>00140 <span class="stringliteral">               fecha_creacion_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,</span>
<a name="l00141"></a>00141 <span class="stringliteral">               fecha_actualizacion_in TIMESTAMP,</span>
<a name="l00142"></a>00142 <span class="stringliteral">               PRIMARY KEY (id)</span>
<a name="l00143"></a>00143 <span class="stringliteral">               )&quot;</span>;
<a name="l00144"></a>00144             $sqlResult = $this-&gt;pdo-&gt;query($SQL);
<a name="l00145"></a>00145 
<a name="l00146"></a>00146             $SQL=<span class="stringliteral">&quot;CREATE TABLE &quot;</span>.$this-&gt;prefijo.<span class="stringliteral">&quot;r_etiqueta_archivo (</span>
<a name="l00147"></a>00147 <span class="stringliteral">               etiquetas_id MEDIUMINT NOT NULL,</span>
<a name="l00148"></a>00148 <span class="stringliteral">               archivos_id MEDIUMINT NOT NULL,</span>
<a name="l00149"></a>00149 <span class="stringliteral">               PRIMARY KEY (etiquetas_id, archivos_id)</span>
<a name="l00150"></a>00150 <span class="stringliteral">               )&quot;</span>;
<a name="l00151"></a>00151             $sqlResult = $this-&gt;pdo-&gt;query($SQL);
<a name="l00152"></a>00152             <span class="keywordflow">break</span>;
<a name="l00153"></a>00153 
<a name="l00154"></a>00154          <span class="keywordflow">default</span>:
<a name="l00155"></a>00155             registrar(__FILE__,__LINE__,<span class="stringliteral">&#39;El driver [&#39;</span>.$driver.<span class="stringliteral">&#39;] para la base de datos no está soportado&#39;</span>,<span class="stringliteral">&#39;ERROR&#39;</span>);
<a name="l00156"></a>00156             <span class="keywordflow">break</span>;
<a name="l00157"></a>00157 
<a name="l00158"></a>00158          }
<a name="l00159"></a>00159 
<a name="l00160"></a>00160       registrar(__FILE__,__LINE__,<span class="stringliteral">&#39;Tablas creadas para &#39;</span>.$driver.<span class="stringliteral">&#39; y preparadas para indexación&#39;</span>,<span class="stringliteral">&#39;ADMIN&#39;</span>);
<a name="l00161"></a>00161 
<a name="l00162"></a>00162       }
<a name="l00163"></a>00163 <span class="comment"></span>
<a name="l00164"></a>00164 <span class="comment">   /** formulario_busqueda</span>
<a name="l00165"></a>00165 <span class="comment">    *</span>
<a name="l00166"></a>00166 <span class="comment">    * Presentamos formulario de busqueda</span>
<a name="l00167"></a>00167 <span class="comment">    */</span>
<a name="l00168"></a>00168 
<a name="l00169"></a><a class="code" href="../../d5/df9/a00044_af616b60a752b803c4eb655dd07dca0f8.html#af616b60a752b803c4eb655dd07dca0f8">00169</a>    <span class="keyword">function</span> <a class="code" href="../../d5/df9/a00044_af616b60a752b803c4eb655dd07dca0f8.html#af616b60a752b803c4eb655dd07dca0f8" title="formulario_busqueda">formulario_busqueda</a>() {
<a name="l00170"></a>00170 
<a name="l00171"></a>00171       global <a class="code" href="../../d4/d63/a00082_a19a0c049e76bf73f0a16f04e31cfbe86.html#a19a0c049e76bf73f0a16f04e31cfbe86" title="Instancia de Gcm.">$gcm</a>;
<a name="l00172"></a>00172 
<a name="l00173"></a>00173       $this-&gt;<a class="code" href="../../d4/dca/a00048_afde3a8df6c433ad68cc593072e489a92.html#afde3a8df6c433ad68cc593072e489a92" title="Añadir archivos javascript a la lista de Gcm.">javascripts</a>(<span class="stringliteral">&#39;indexador.js&#39;</span>);
<a name="l00174"></a>00174 
<a name="l00175"></a>00175       include($gcm-&gt;event-&gt;instancias[<span class="stringliteral">&#39;temas&#39;</span>]-&gt;ruta(<span class="stringliteral">&#39;indexador&#39;</span>,<span class="stringliteral">&#39;html&#39;</span>,<span class="stringliteral">&#39;caja_buscar.html&#39;</span>));
<a name="l00176"></a>00176 
<a name="l00177"></a>00177       }
<a name="l00178"></a>00178 <span class="comment"></span>
<a name="l00179"></a>00179 <span class="comment">   /** sql_quote</span>
<a name="l00180"></a>00180 <span class="comment">    *</span>
<a name="l00181"></a>00181 <span class="comment">    * para evitar sql injection y escapar contenido que podría dar problemas al insertar en la </span>
<a name="l00182"></a>00182 <span class="comment">    * base de datos.</span>
<a name="l00183"></a>00183 <span class="comment">    *</span>
<a name="l00184"></a>00184 <span class="comment">    * @param string Cadena a validar, para evitar injecciones de sql</span>
<a name="l00185"></a>00185 <span class="comment">    *</span>
<a name="l00186"></a>00186 <span class="comment">    * @return Cadena escapada</span>
<a name="l00187"></a>00187 <span class="comment">    *</span>
<a name="l00188"></a>00188 <span class="comment">    * @author Eduardo Magrané</span>
<a name="l00189"></a>00189 <span class="comment">    * @version 1.0</span>
<a name="l00190"></a>00190 <span class="comment">    * @fuente http://www.forosdelweb.com/f18/funcion-anti-sql-injection-587921/</span>
<a name="l00191"></a>00191 <span class="comment">    *</span>
<a name="l00192"></a>00192 <span class="comment">    */</span>
<a name="l00193"></a>00193 
<a name="l00194"></a><a class="code" href="../../d5/df9/a00044_a8ee07bb364e7fb1351a3b8cff8e3ccfb.html#a8ee07bb364e7fb1351a3b8cff8e3ccfb">00194</a>    <span class="keyword">function</span> <a class="code" href="../../d5/df9/a00044_a8ee07bb364e7fb1351a3b8cff8e3ccfb.html#a8ee07bb364e7fb1351a3b8cff8e3ccfb" title="sql_quote">sql_quote</a>($valor) {
<a name="l00195"></a>00195 
<a name="l00196"></a>00196       $valor = sqlite_escape_string($valor);
<a name="l00197"></a>00197       <span class="keywordflow">return</span> $valor;
<a name="l00198"></a>00198 
<a name="l00199"></a>00199       }
<a name="l00200"></a>00200 <span class="comment"></span>
<a name="l00201"></a>00201 <span class="comment">   /** indexar_archivo_pdo</span>
<a name="l00202"></a>00202 <span class="comment">    *</span>
<a name="l00203"></a>00203 <span class="comment">    * Añadimos información sobre un archivo</span>
<a name="l00204"></a>00204 <span class="comment">    *</span>
<a name="l00205"></a>00205 <span class="comment">    * Los parametros son recogidos por recoger_parametros()</span>
<a name="l00206"></a>00206 <span class="comment">    *</span>
<a name="l00207"></a>00207 <span class="comment">    * Si tenemos inicio_descripción en parametros, recogemos el contenido del archivo a partir </span>
<a name="l00208"></a>00208 <span class="comment">    * de encontrar la parte de texto recibida màs su logintud</span>
<a name="l00209"></a>00209 <span class="comment">    *</span>
<a name="l00210"></a>00210 <span class="comment">    * @author Eduardo Magrané</span>
<a name="l00211"></a>00211 <span class="comment">    * @version 1.0</span>
<a name="l00212"></a>00212 <span class="comment">    *</span>
<a name="l00213"></a>00213 <span class="comment">    * @param $e Evento</span>
<a name="l00214"></a>00214 <span class="comment">    * @param $args Parametros</span>
<a name="l00215"></a>00215 <span class="comment">    *</span>
<a name="l00216"></a>00216 <span class="comment">    * @return TRUE/FALSE</span>
<a name="l00217"></a>00217 <span class="comment">    *</span>
<a name="l00218"></a>00218 <span class="comment">    */</span>
<a name="l00219"></a>00219 
<a name="l00220"></a><a class="code" href="../../d5/df9/a00044_a775a6bedde0982bd9a393dbc15d65f42.html#a775a6bedde0982bd9a393dbc15d65f42">00220</a>    <span class="keyword">function</span> <a class="code" href="../../d5/df9/a00044_a775a6bedde0982bd9a393dbc15d65f42.html#a775a6bedde0982bd9a393dbc15d65f42" title="indexar_archivo_pdo">indexar_archivo_pdo</a>($e, $args) {
<a name="l00221"></a>00221 
<a name="l00222"></a>00222       global <a class="code" href="../../d4/d63/a00082_a19a0c049e76bf73f0a16f04e31cfbe86.html#a19a0c049e76bf73f0a16f04e31cfbe86" title="Instancia de Gcm.">$gcm</a>;
<a name="l00223"></a>00223 
<a name="l00224"></a>00224       $parametros = <a class="code" href="../../df/d98/a00107_a30a2aab875d1c34d154086ccfc7066e6.html#a30a2aab875d1c34d154086ccfc7066e6" title="Recogemos los argumentos entregados a una función y devolvemos un array con par valor.">recoger_parametros</a>($args);
<a name="l00225"></a>00225 
<a name="l00226"></a>00226       <span class="keywordflow">if</span> ( isset($parametros[<span class="stringliteral">&#39;url&#39;</span>]) ) {                 <span class="comment">// Si tenemos a entrar</span>
<a name="l00227"></a>00227          $file = $parametros[<span class="stringliteral">&#39;url&#39;</span>] ;
<a name="l00228"></a>00228          registrar(__FILE__,__LINE__,<span class="stringliteral">&#39;Recibimos un archivo para indexar desde args[url] &#39;</span>.$file);
<a name="l00229"></a>00229       } elseif ( ! is_array($args) &amp;&amp; is_file($args) ) {                      <span class="comment">// Si args es la ruta de fichero</span>
<a name="l00230"></a>00230          $file = $args ;
<a name="l00231"></a>00231          registrar(__FILE__,__LINE__,<span class="stringliteral">&#39;Recibimos un archivo para indexar desde args=&#39;</span>.$file);
<a name="l00232"></a>00232       } elseif ( isset($gcm-&gt;memoria[<span class="stringliteral">&#39;destino&#39;</span>]) ) {     <span class="comment">// Si se guardo destino en memoria de gcm al mover documento</span>
<a name="l00233"></a>00233          $file = $gcm-&gt;memoria[<span class="stringliteral">&#39;destino&#39;</span>] ;
<a name="l00234"></a>00234          registrar(__FILE__,__LINE__,<span class="stringliteral">&#39;Recibimos un archivo para indexar desde gcm-&gt;memoria[destino] &#39;</span>.$file);
<a name="l00235"></a>00235       } elseif ( <a class="code" href="../../d9/d73/a00060_a23c42e7d231a63025b55e4eb7e3d4c99.html#a23c42e7d231a63025b55e4eb7e3d4c99" title="Url del contenido que se pide.">Router::$f</a> ) {                          <span class="comment">// Documento actual</span>
<a name="l00236"></a>00236          $file = <a class="code" href="../../d9/d73/a00060_a23c42e7d231a63025b55e4eb7e3d4c99.html#a23c42e7d231a63025b55e4eb7e3d4c99" title="Url del contenido que se pide.">Router::$f</a> ;
<a name="l00237"></a>00237          registrar(__FILE__,__LINE__,<span class="stringliteral">&#39;Indexamos contenido actual: &#39;</span>.$file);
<a name="l00238"></a>00238       } <span class="keywordflow">else</span> {
<a name="l00239"></a>00239          $gcm-&gt;registra(__FILE__,__LINE__,<span class="stringliteral">&#39;Se necesita url de contenido para indexar::&#39;</span>.$args,<span class="stringliteral">&#39;ERROR&#39;</span>);
<a name="l00240"></a>00240          <span class="keywordflow">return</span> FALSE;
<a name="l00241"></a>00241          }
<a name="l00242"></a>00242 
<a name="l00243"></a>00243       $file = str_replace(<span class="stringliteral">&#39;//&#39;</span>,<span class="charliteral">&#39;/&#39;</span>,$file);
<a name="l00244"></a>00244 
<a name="l00245"></a>00245       <span class="comment">/* Si no es un archivo html nos vamos */</span>
<a name="l00246"></a>00246 
<a name="l00247"></a>00247       <span class="keywordflow">if</span> ( ! isset($parametros[<span class="stringliteral">&#39;sin_comprobar_extension&#39;</span>]) &amp;&amp; substr($file, -5) !== <span class="stringliteral">&#39;.html&#39;</span> ) {
<a name="l00248"></a>00248          registrar(__FILE__,__LINE__,__CLASS__.<span class="stringliteral">&#39;-&gt;&#39;</span>.__FUNCTION__.<span class="charliteral">&#39;(&#39;</span>.$e.<span class="charliteral">&#39;,&#39;</span>.<a class="code" href="../../df/d98/a00107_a7031d9d8dc6290aa33d665d7daced6c8.html#a7031d9d8dc6290aa33d665d7daced6c8" title="Formatemaos salida de array.">depurar</a>($args).
<a name="l00249"></a>00249             <span class="stringliteral">&#39;No tiene extension html, salimos&#39;</span>);
<a name="l00250"></a>00250          <span class="keywordflow">return</span> FALSE;
<a name="l00251"></a>00251          }
<a name="l00252"></a>00252 
<a name="l00253"></a>00253       <span class="comment">/* Literal para el nombre de archivo */</span>
<a name="l00254"></a>00254 
<a name="l00255"></a>00255       <span class="keywordflow">if</span> ( isset($parametros[<span class="stringliteral">&#39;literal&#39;</span>])  ) {
<a name="l00256"></a>00256          $nombre = $parametros[<span class="stringliteral">&#39;literal&#39;</span>];
<a name="l00257"></a>00257       } <span class="keywordflow">else</span> {
<a name="l00258"></a>00258          $nombre = str_replace(<span class="stringliteral">&#39;.html&#39;</span>,<span class="stringliteral">&#39;&#39;</span>,basename($file) );
<a name="l00259"></a>00259          $nombre = literal($nombre);
<a name="l00260"></a>00260          }
<a name="l00261"></a>00261 
<a name="l00262"></a>00262       $descripcion=<span class="stringliteral">&#39;&#39;</span>;                                                                             <span class="comment">///&lt; Descripción</span>
<a name="l00263"></a>00263 <span class="comment"></span>
<a name="l00264"></a>00264       <span class="comment">// Eliminamos File/es de la url</span>
<a name="l00265"></a>00265       $url=str_replace(<span class="stringliteral">&#39;File/&#39;</span>.$gcm-&gt;config(<span class="stringliteral">&#39;idiomas&#39;</span>,<span class="stringliteral">&#39;Idioma por defecto&#39;</span>).<span class="charliteral">&#39;/&#39;</span>,<span class="stringliteral">&#39;&#39;</span>,$file);
<a name="l00266"></a>00266 
<a name="l00267"></a>00267       $fichero = <span class="stringliteral">&#39;File/&#39;</span>.Router::$ii.<span class="charliteral">&#39;/&#39;</span>.stripslashes(html_entity_decode($url));
<a name="l00268"></a>00268       <span class="comment">// Si no existe el fichero nos volvemos</span>
<a name="l00269"></a>00269 
<a name="l00270"></a>00270       <span class="keywordflow">if</span> ( ! @file_exists($fichero) ) {
<a name="l00271"></a>00271          registrar(__FILE__,__LINE__,__CLASS__.<span class="stringliteral">&#39;-&gt;&#39;</span>.__FUNCTION__.<span class="charliteral">&#39;(&#39;</span>.$e.<span class="charliteral">&#39;,&#39;</span>.<a class="code" href="../../df/d98/a00107_a7031d9d8dc6290aa33d665d7daced6c8.html#a7031d9d8dc6290aa33d665d7daced6c8" title="Formatemaos salida de array.">depurar</a>($args).
<a name="l00272"></a>00272             <span class="stringliteral">&#39;No existe [&#39;</span>.$fichero.<span class="stringliteral">&#39;] archivo, salimos&#39;</span>);
<a name="l00273"></a>00273          return ;
<a name="l00274"></a>00274          }
<a name="l00275"></a>00275 
<a name="l00276"></a>00276       $fecha_creacion_at = date(<span class="stringliteral">&#39;Y-m-d H:i:s&#39;</span>, filemtime($fichero));
<a name="l00277"></a>00277       $fecha_actualizacion_in = $fecha_creacion_at;
<a name="l00278"></a>00278       $tags = array();
<a name="l00279"></a>00279 
<a name="l00280"></a>00280       $gcm-&gt;registra(__FILE__,__LINE__,<span class="stringliteral">&quot;Indexamos $file $fecha_creacion_at $fecha_actualizacion_in &quot;</span>);
<a name="l00281"></a>00281 
<a name="l00282"></a>00282       <span class="comment">// Si tenemos inicio_descripción en parametros, recogemos el contenido del archivo a partir </span>
<a name="l00283"></a>00283       <span class="comment">// de encontrar la parte de texto recibida</span>
<a name="l00284"></a>00284 
<a name="l00285"></a>00285       $archivo_contenido = $fichero;
<a name="l00286"></a>00286 
<a name="l00287"></a>00287       <span class="comment">// Si tenemos en parametros &#39;archivo_descripcion&#39; lo utlizamos para</span>
<a name="l00288"></a>00288       <span class="comment">// obtener la descripción de su contenido, sino sera el mismo archivo</span>
<a name="l00289"></a>00289       <span class="comment">// a indexar</span>
<a name="l00290"></a>00290 
<a name="l00291"></a>00291       <span class="keywordflow">if</span> ( ( isset($parametros[<span class="stringliteral">&#39;archivo_descripcion&#39;</span>]) ) ) {
<a name="l00292"></a>00292          $archivo_contenido = $parametros[<span class="stringliteral">&#39;archivo_descripcion&#39;</span>];
<a name="l00293"></a>00293          }
<a name="l00294"></a>00294 
<a name="l00295"></a>00295       <span class="keywordflow">if</span> ( ( isset($parametros[<span class="stringliteral">&#39;inicio_descripcion&#39;</span>]) ) ) {
<a name="l00296"></a>00296 
<a name="l00297"></a>00297          $contenido = file_get_contents($archivo_contenido);
<a name="l00298"></a>00298          $posicion = strpos($contenido,$parametros[<span class="stringliteral">&#39;inicio_descripcion&#39;</span>]);
<a name="l00299"></a>00299          <span class="keywordflow">if</span> ( $posicion === FALSE ) {
<a name="l00300"></a>00300             registrar(__FILE__,__LINE__,<span class="stringliteral">&#39;No se encontro [&#39;</span>.$parametros[<span class="stringliteral">&#39;inicio_descripcion&#39;</span>].<span class="stringliteral">&#39;] en [&#39;</span>.$archivo_contenido.<span class="charliteral">&#39;]&#39;</span>,<span class="stringliteral">&#39;ADMIN&#39;</span>);
<a name="l00301"></a>00301          } <span class="keywordflow">else</span> {
<a name="l00302"></a>00302             $posicion = $posicion + strlen($parametros[<span class="stringliteral">&#39;inicio_descripcion&#39;</span>]);
<a name="l00303"></a>00303             }
<a name="l00304"></a>00304 
<a name="l00305"></a>00305          $contenido = trim(substr($contenido,$posicion));
<a name="l00306"></a>00306          $contenido = strip_tags($contenido);
<a name="l00307"></a>00307 
<a name="l00308"></a>00308       } elseif ( isset($parametros[<span class="stringliteral">&#39;descripcion&#39;</span>])) {
<a name="l00309"></a>00309 
<a name="l00310"></a>00310          <span class="comment">// La descripción nos llega directamente.</span>
<a name="l00311"></a>00311 
<a name="l00312"></a>00312          $contenido = strip_tags($parametros[<span class="stringliteral">&#39;descripcion&#39;</span>]);
<a name="l00313"></a>00313 
<a name="l00314"></a>00314       } <span class="keywordflow">else</span> {
<a name="l00315"></a>00315 
<a name="l00316"></a>00316          $contenido = strip_tags(file_get_contents($archivo_contenido)); <span class="comment">///&lt; Contenido del archivo</span>
<a name="l00317"></a>00317 <span class="comment"></span>         }
<a name="l00318"></a>00318 
<a name="l00319"></a>00319       <span class="keywordflow">while</span> ( $pos1 = strpos($contenido, <span class="stringliteral">&quot;{Tags{&quot;</span>) ) {
<a name="l00320"></a>00320          $pos2 = strpos($contenido, <span class="stringliteral">&quot;}}&quot;</span>, $pos1);
<a name="l00321"></a>00321          <span class="keywordflow">if</span> ( $pos1 &gt; 0 &amp;&amp; $pos2 &lt; $pos1 ) {
<a name="l00322"></a>00322             $gcm-&gt;registra(__FILE__,__LINE__,<span class="stringliteral">&#39;Error de formato en etiquetas [&#39;</span>.$url.<span class="charliteral">&#39;]&#39;</span>,<span class="stringliteral">&#39;ERROR&#39;</span>);
<a name="l00323"></a>00323             $contenido = str_replace(<span class="stringliteral">&#39;{Tags{&#39;</span>,<span class="stringliteral">&#39;&#39;</span>,$contenido);
<a name="l00324"></a>00324          }
<a name="l00325"></a>00325          $remplazar = substr($contenido, $pos1, $pos2 - $pos1 + 2);
<a name="l00326"></a>00326          $lit = str_replace(<span class="stringliteral">&#39;{Tags{&#39;</span>,<span class="stringliteral">&#39;&#39;</span>,$remplazar);
<a name="l00327"></a>00327          $lit = str_replace(<span class="stringliteral">&#39;}}&#39;</span>,<span class="stringliteral">&#39;&#39;</span>,$lit);
<a name="l00328"></a>00328          $contenido = str_replace($remplazar,literal($lit),$contenido);
<a name="l00329"></a>00329          $tags = array_merge($tags,explode(<span class="charliteral">&#39;,&#39;</span>,$lit));
<a name="l00330"></a>00330          }
<a name="l00331"></a>00331 
<a name="l00332"></a>00332       <span class="comment">// Si la posición de las etiquetas es menor a maxLong cortamos hasta la etiqueta.</span>
<a name="l00333"></a>00333       <span class="keywordflow">if</span> ( $pos1 &amp;&amp; $pos1 &lt; $this-&gt;maxLong ) { $this-&gt;maxLong = $pos1; }
<a name="l00334"></a>00334 
<a name="l00335"></a>00335       <span class="comment">// Hacemos lo mismo con las referencias.</span>
<a name="l00336"></a>00336       $posRef = strpos($contenido, <span class="stringliteral">&quot;{Ref{&quot;</span>);
<a name="l00337"></a>00337       <span class="keywordflow">if</span> ( $posRef &amp;&amp; $posRef &lt; $this-&gt;maxLong ) { $this-&gt;maxLong = $posRef; }
<a name="l00338"></a>00338 
<a name="l00339"></a>00339       $descripcion=trim(substr($contenido,0,$this-&gt;maxLong)).<span class="stringliteral">&quot;...&quot;</span>;                                      <span class="comment">///&lt; Descripción para la BD</span>
<a name="l00340"></a>00340 <span class="comment"></span>
<a name="l00341"></a>00341       <span class="comment">// Comprobar si existe ya el archivo en la base de datos en tal caso lo modificamos</span>
<a name="l00342"></a>00342       $SQL = <span class="stringliteral">&quot;SELECT id from &quot;</span>.$this-&gt;prefijo.<span class="stringliteral">&quot;archivos WHERE url=?&quot;</span>;
<a name="l00343"></a>00343       <span class="keywordflow">if</span> ( $sqlResult = $this-&gt;pdo-&gt;prepare($SQL) ) {
<a name="l00344"></a>00344          $sqlResult-&gt;execute(array($url));
<a name="l00345"></a>00345          $res = $sqlResult-&gt;fetch();
<a name="l00346"></a>00346          $archivo_id = $res[0];
<a name="l00347"></a>00347       } <span class="keywordflow">else</span> {
<a name="l00348"></a>00348          $archivo_id = FALSE ;
<a name="l00349"></a>00349          }
<a name="l00350"></a>00350 
<a name="l00351"></a>00351       <span class="keywordflow">if</span> ( $archivo_id ) {
<a name="l00352"></a>00352          $SQL = <span class="stringliteral">&quot;UPDATE &quot;</span>.$this-&gt;prefijo.<span class="stringliteral">&quot;archivos SET nombre=?, descripcion=?, fecha_actualizacion_in=?&quot;</span>;
<a name="l00353"></a>00353          $SQL .= <span class="stringliteral">&quot; WHERE id=? &quot;</span>;
<a name="l00354"></a>00354          $gcm-&gt;registra(__FILE__,__LINE__,<span class="stringliteral">&#39;Actualizamos: &#39;</span>.$url);
<a name="l00355"></a>00355          $comando = $this-&gt;pdo-&gt;prepare($SQL);
<a name="l00356"></a>00356          <span class="keywordflow">if</span> ( ! $comando-&gt;execute(array($nombre,$descripcion, $fecha_actualizacion_in, $archivo_id) ) ) {
<a name="l00357"></a>00357             $err = $this-&gt;pdo-&gt;errorInfo();
<a name="l00358"></a>00358             $err_msg = $err[2];
<a name="l00359"></a>00359             $gcm-&gt;registra(__FILE__,__LINE__,<span class="stringliteral">&#39;ERROR al ejecutar &#39;</span>.$SQL,<span class="stringliteral">&#39;ERROR&#39;</span>);
<a name="l00360"></a>00360             $gcm-&gt;registra(__FILE__,__LINE__,$err_msg,<span class="stringliteral">&#39;ERROR&#39;</span>);
<a name="l00361"></a>00361             <span class="keywordflow">return</span> FALSE;
<a name="l00362"></a>00362             }
<a name="l00363"></a>00363       } <span class="keywordflow">else</span> {
<a name="l00364"></a>00364          <span class="comment">// Insertamos datos en base de datos</span>
<a name="l00365"></a>00365          $SQL = <span class="stringliteral">&quot;INSERT INTO &quot;</span>.$this-&gt;prefijo.<span class="stringliteral">&quot;archivos ( nombre, descripcion, url, fecha_creacion_at, fecha_actualizacion_in ) VALUES &quot;</span>;
<a name="l00366"></a>00366          $SQL .= <span class="stringliteral">&quot;(?,?,?,?,?)&quot;</span>;
<a name="l00367"></a>00367          $gcm-&gt;registra(__FILE__,__LINE__,<span class="stringliteral">&#39;Indexador::Insertamos: &#39;</span>.$url);
<a name="l00368"></a>00368 
<a name="l00369"></a>00369          <span class="keywordflow">try</span> {
<a name="l00370"></a>00370 
<a name="l00371"></a>00371             $comando = $this-&gt;pdo-&gt;prepare($SQL);
<a name="l00372"></a>00372             $comando-&gt;execute(array($nombre,$descripcion,$url, $fecha_creacion_at, $fecha_actualizacion_in) );
<a name="l00373"></a>00373 
<a name="l00374"></a>00374          } <span class="keywordflow">catch</span> (Exception $ex) {
<a name="l00375"></a>00375 
<a name="l00376"></a>00376             $mens = $ex-&gt;getMessage().<span class="stringliteral">&quot;\nsql: &quot;</span>.$SQL.
<a name="l00377"></a>00377                <span class="stringliteral">&quot;\n$nombre,$descripcion,$url, $fecha_creacion_at, $fecha_actualizacion_in&quot;</span>;
<a name="l00378"></a>00378             registrar(__FILE__,__LINE__,__CLASS__.<span class="stringliteral">&#39;-&gt;&#39;</span>.__FUNCTION__.<span class="charliteral">&#39;(&#39;</span>.$e.<span class="charliteral">&#39;,&#39;</span>.<a class="code" href="../../df/d98/a00107_a7031d9d8dc6290aa33d665d7daced6c8.html#a7031d9d8dc6290aa33d665d7daced6c8" title="Formatemaos salida de array.">depurar</a>($args).<span class="stringliteral">&#39;) &#39;</span>.<span class="stringliteral">&quot;\n&quot;</span>.$mens,<span class="stringliteral">&#39;ERROR&#39;</span>);
<a name="l00379"></a>00379             <span class="keywordflow">return</span> FALSE;
<a name="l00380"></a>00380 
<a name="l00381"></a>00381             }  
<a name="l00382"></a>00382 
<a name="l00383"></a>00383          }
<a name="l00384"></a>00384 
<a name="l00385"></a>00385       <span class="keywordflow">if</span> ( count($tags) &gt; 0 ) {
<a name="l00386"></a>00386 
<a name="l00387"></a>00387          <span class="keywordflow">if</span> ( ! $archivo_id ) {
<a name="l00388"></a>00388             $archivo_id = $this-&gt;pdo-&gt;lastInsertId();                                      <span class="comment">// Ultimo archivo añadido</span>
<a name="l00389"></a>00389             }
<a name="l00390"></a>00390 
<a name="l00391"></a>00391          <span class="keywordflow">foreach</span> ( $tags as $t ) {
<a name="l00392"></a>00392 
<a name="l00393"></a>00393             <span class="comment">// recuperar id de la etiqueta si la hay sino la creamos</span>
<a name="l00394"></a>00394             $SQL=<span class="stringliteral">&quot;SELECT id FROM &quot;</span>.$this-&gt;prefijo.<span class="stringliteral">&quot;etiquetas WHERE nombre=&#39;&quot;</span>.trim($t).<span class="stringliteral">&quot;&#39;&quot;</span>;
<a name="l00395"></a>00395             <span class="keywordflow">if</span> ( $sqlResult = $this-&gt;pdo-&gt;query($SQL) ) {
<a name="l00396"></a>00396                $res = $sqlResult-&gt;fetch();
<a name="l00397"></a>00397                $etiqueta_id = $res[0];
<a name="l00398"></a>00398             } <span class="keywordflow">else</span> {
<a name="l00399"></a>00399                $etiqueta_id = FALSE ;
<a name="l00400"></a>00400                }
<a name="l00401"></a>00401 
<a name="l00402"></a>00402             <span class="keywordflow">if</span> ( ! $etiqueta_id ) {                                                     <span class="comment">// No hay etiqueta</span>
<a name="l00403"></a>00403                $SQL=<span class="stringliteral">&quot;INSERT INTO &quot;</span>.$this-&gt;prefijo.<span class="stringliteral">&quot;etiquetas (nombre) VALUES (&#39;&quot;</span>.trim($t).<span class="stringliteral">&quot;&#39;)&quot;</span>;
<a name="l00404"></a>00404                <span class="keywordflow">if</span> ( ! $this-&gt;pdo-&gt;query($SQL) ) {      <span class="comment">// Insertamos nueva etiqueta</span>
<a name="l00405"></a>00405                   $err = $this-&gt;pdo-&gt;errorInfo();
<a name="l00406"></a>00406                   $err_msg = $err[2];
<a name="l00407"></a>00407                   $gcm-&gt;registra(__FILE__,__LINE__,<span class="stringliteral">&#39;ERROR al ejecutar &#39;</span>.$SQL,<span class="stringliteral">&#39;ERROR&#39;</span>);
<a name="l00408"></a>00408                   $gcm-&gt;registra(__FILE__,__LINE__,$err_msg,<span class="stringliteral">&#39;ERROR&#39;</span>);
<a name="l00409"></a>00409 
<a name="l00410"></a>00410                   }
<a name="l00411"></a>00411                $etiqueta_id = $this-&gt;pdo-&gt;lastInsertId();                                   <span class="comment">// Ultima etiqueta añadida</span>
<a name="l00412"></a>00412                }
<a name="l00413"></a>00413 
<a name="l00414"></a>00414             $SQL = <span class="stringliteral">&quot;INSERT INTO &quot;</span>.$this-&gt;prefijo.<span class="stringliteral">&quot;r_etiqueta_archivo VALUES (&quot;</span>.$etiqueta_id.<span class="stringliteral">&quot;,&quot;</span>.$archivo_id.<span class="stringliteral">&quot;)&quot;</span>;      <span class="comment">// Insertamos relacion</span>
<a name="l00415"></a>00415 
<a name="l00416"></a>00416             <span class="keywordflow">try</span> {
<a name="l00417"></a>00417 
<a name="l00418"></a>00418                $this-&gt;pdo-&gt;query($SQL);
<a name="l00419"></a>00419 
<a name="l00420"></a>00420             } <span class="keywordflow">catch</span> (Exception $ex) {
<a name="l00421"></a>00421 
<a name="l00422"></a>00422                $gcm-&gt;registra(__FILE__,__LINE__,<span class="stringliteral">&#39;ERROR al ejecutar &#39;</span>.$SQL);
<a name="l00423"></a>00423                $gcm-&gt;registra(__FILE__,__LINE__,$ex-&gt;getMessage());
<a name="l00424"></a>00424 
<a name="l00425"></a>00425                }
<a name="l00426"></a>00426 
<a name="l00427"></a>00427             }
<a name="l00428"></a>00428          }
<a name="l00429"></a>00429 
<a name="l00430"></a>00430       <span class="keywordflow">if</span> ( ( $e == <span class="stringliteral">&#39;indexar&#39;</span> )  ) {
<a name="l00431"></a>00431          $gcm-&gt;registra(__FILE__,__LINE__,<span class="stringliteral">&#39;Archivo indexado&#39;</span>,<span class="stringliteral">&#39;AVISO&#39;</span>);
<a name="l00432"></a>00432       } <span class="keywordflow">else</span> {
<a name="l00433"></a>00433          $gcm-&gt;registra(__FILE__,__LINE__,literal(<span class="stringliteral">&#39;Archivo indexado&#39;</span>));
<a name="l00434"></a>00434          }
<a name="l00435"></a>00435       <span class="keywordflow">return</span> TRUE;
<a name="l00436"></a>00436 
<a name="l00437"></a>00437       }
<a name="l00438"></a>00438 <span class="comment"></span>
<a name="l00439"></a>00439 <span class="comment">   /**</span>
<a name="l00440"></a>00440 <span class="comment">    * ultimas_entradas</span>
<a name="l00441"></a>00441 <span class="comment">    *</span>
<a name="l00442"></a>00442 <span class="comment">    * Presentamos ultimas entradas </span>
<a name="l00443"></a>00443 <span class="comment">    *</span>
<a name="l00444"></a>00444 <span class="comment">    * @author Eduardo Magrané</span>
<a name="l00445"></a>00445 <span class="comment">    * @version 1.0</span>
<a name="l00446"></a>00446 <span class="comment">    *</span>
<a name="l00447"></a>00447 <span class="comment">    * @param num Numero de entradas que queremos que se presenten</span>
<a name="l00448"></a>00448 <span class="comment">    * @param seccion filtramos por sección</span>
<a name="l00449"></a>00449 <span class="comment">    * @param formato Formato de salida, por defecto 0:</span>
<a name="l00450"></a>00450 <span class="comment">    *        0: Salida para contenido</span>
<a name="l00451"></a>00451 <span class="comment">    *        1: columna</span>
<a name="l00452"></a>00452 <span class="comment">    *</span>
<a name="l00453"></a>00453 <span class="comment">    * @return TRUE/FALSE</span>
<a name="l00454"></a>00454 <span class="comment">    *</span>
<a name="l00455"></a>00455 <span class="comment">    */</span>
<a name="l00456"></a>00456 
<a name="l00457"></a><a class="code" href="../../d5/df9/a00044_ad8635978c25709ea90addc47c5d695cb.html#ad8635978c25709ea90addc47c5d695cb">00457</a>    <span class="keyword">function</span> <a class="code" href="../../d5/df9/a00044_ad8635978c25709ea90addc47c5d695cb.html#ad8635978c25709ea90addc47c5d695cb" title="ultimas_entradas">ultimas_entradas</a>($e, $args) {
<a name="l00458"></a>00458 
<a name="l00459"></a>00459       global <a class="code" href="../../d4/d63/a00082_a19a0c049e76bf73f0a16f04e31cfbe86.html#a19a0c049e76bf73f0a16f04e31cfbe86" title="Instancia de Gcm.">$gcm</a>;
<a name="l00460"></a>00460 
<a name="l00461"></a>00461       $this-&gt;<a class="code" href="../../d4/dca/a00048_afde3a8df6c433ad68cc593072e489a92.html#afde3a8df6c433ad68cc593072e489a92" title="Añadir archivos javascript a la lista de Gcm.">javascripts</a>(<span class="stringliteral">&#39;indexador.js&#39;</span>);
<a name="l00462"></a>00462 
<a name="l00463"></a>00463       $sufijo = <span class="stringliteral">&#39;uec_&#39;</span>; <span class="comment">// Sufijo para pajinador (ultimas entradas contenido)</span>
<a name="l00464"></a>00464 
<a name="l00465"></a>00465       <span class="comment">// Por defecto</span>
<a name="l00466"></a>00466       $num_items_df = 5;
<a name="l00467"></a>00467       $formato_df = 0; <span class="comment">// Listado</span>
<a name="l00468"></a>00468 
<a name="l00469"></a>00469       $parametros = <a class="code" href="../../df/d98/a00107_a30a2aab875d1c34d154086ccfc7066e6.html#a30a2aab875d1c34d154086ccfc7066e6" title="Recogemos los argumentos entregados a una función y devolvemos un array con par valor.">recoger_parametros</a>($args);
<a name="l00470"></a>00470 
<a name="l00471"></a>00471       $num = ( isset($parametros[<span class="stringliteral">&#39;num&#39;</span>]) ) ? $parametros[<span class="stringliteral">&#39;num&#39;</span>] : $num_items_df ;
<a name="l00472"></a>00472       $seccion = ( isset($parametros[<span class="stringliteral">&#39;seccion&#39;</span>]) ) ? $parametros[<span class="stringliteral">&#39;seccion&#39;</span>] : <a class="code" href="../../d9/d73/a00060_a50b05cf2e02ef0b67fcad97106dd7634.html#a50b05cf2e02ef0b67fcad97106dd7634" title="Sección.">Router::$s</a> ;
<a name="l00473"></a>00473       $formato = ( isset($parametros[<span class="stringliteral">&#39;formato&#39;</span>]) ) ? $parametros[<span class="stringliteral">&#39;formato&#39;</span>] : $formato_df ;
<a name="l00474"></a>00474 
<a name="l00475"></a>00475       <span class="keywordflow">if</span> ( $formato == 0  ) $this-&gt;ultimos_en_contenido = TRUE;
<a name="l00476"></a>00476 
<a name="l00477"></a>00477       <span class="keywordflow">if</span> ( $formato == 1  &amp;&amp; $this-&gt;ultimos_en_contenido ) {
<a name="l00478"></a>00478          registrar(__FILE__,__LINE__,
<a name="l00479"></a>00479             __CLASS__.<span class="stringliteral">&#39;-&gt;&#39;</span>.__FUNCTION__.<span class="charliteral">&#39;(&#39;</span>.$e.<span class="charliteral">&#39;,&#39;</span>.<a class="code" href="../../df/d98/a00107_a7031d9d8dc6290aa33d665d7daced6c8.html#a7031d9d8dc6290aa33d665d7daced6c8" title="Formatemaos salida de array.">depurar</a>($args).<span class="stringliteral">&#39;) Ya tenemos ultimas entradas </span>
<a name="l00480"></a>00480 <span class="stringliteral">            en contenido, no las ponemos en columna&#39;</span>);
<a name="l00481"></a>00481          <span class="keywordflow">return</span>;
<a name="l00482"></a>00482          }
<a name="l00483"></a>00483 
<a name="l00484"></a>00484       <span class="keywordflow">if</span> ( !empty($seccion) ) {
<a name="l00485"></a>00485          $aSeccion_actual = explode(<span class="charliteral">&#39;/&#39;</span>,<a class="code" href="../../df/d98/a00107_a6ab4ae106b6ebf5769bc3390aa8ac287.html#a6ab4ae106b6ebf5769bc3390aa8ac287" title="comprobar_barra()">comprobar_barra</a>($seccion));
<a name="l00486"></a>00486          $seccion_actual = ( $aSeccion_actual[count($aSeccion_actual)-2] ) ? literal($aSeccion_actual[count($aSeccion_actual)-2],1) : NULL ;
<a name="l00487"></a>00487          }
<a name="l00488"></a>00488 
<a name="l00489"></a>00489       $estamos = ( isset($seccion_actual) ) ? $seccion_actual : <span class="stringliteral">&#39;inicio&#39;</span> ;
<a name="l00490"></a>00490 
<a name="l00491"></a>00491       $condicion = ( $seccion ) ? <span class="stringliteral">&quot;url like &#39;&quot;</span>.$seccion.<span class="stringliteral">&quot;%&#39;&quot;</span> : NULL ;
<a name="l00492"></a>00492 
<a name="l00493"></a>00493       $sql = <span class="stringliteral">&quot;SELECT nombre, url, descripcion, fecha_actualizacion_in, fecha_creacion_at FROM &quot;</span>.$this-&gt;prefijo.<span class="stringliteral">&quot;archivos &quot;</span>;
<a name="l00494"></a>00494       if ( $condicion) $sql .= <span class="stringliteral">&quot;WHERE $condicion&quot;</span>;
<a name="l00495"></a>00495       $sql .= <span class="stringliteral">&quot; ORDER BY fecha_actualizacion_in desc&quot;</span>;
<a name="l00496"></a>00496 
<a name="l00497"></a>00497       require_once(GCM_DIR.<span class="stringliteral">&#39;lib/int/GcmPDO/lib/paginarPDO.php&#39;</span>);
<a name="l00498"></a>00498 
<a name="l00499"></a>00499       <span class="keywordflow">if</span> ( $formato == 0 ) { <span class="comment">// Formato para contenido</span>
<a name="l00500"></a>00500 
<a name="l00501"></a>00501          $gcm-&gt;event-&gt;anular(<span class="stringliteral">&#39;titulo&#39;</span>,<span class="stringliteral">&#39;indexador&#39;</span>);
<a name="l00502"></a>00502          <span class="keywordflow">if</span> ( $estamos == <span class="stringliteral">&#39;inicio&#39;</span> || empty($seccion) ) {
<a name="l00503"></a>00503             $gcm-&gt;titulo=literal(<span class="stringliteral">&#39;Últimas entradas&#39;</span>);
<a name="l00504"></a>00504          } <span class="keywordflow">else</span> {
<a name="l00505"></a>00505             $gcm-&gt;titulo=literal(<span class="stringliteral">&#39;Últimas entradas en&#39;</span>,3).<span class="charliteral">&#39; &#39;</span>.$seccion_actual;
<a name="l00506"></a>00506             }
<a name="l00507"></a>00507 
<a name="l00508"></a>00508          $pd = <span class="keyword">new</span> <a class="code" href="../../d2/dee/a00049.html" title="Recogemos clase padre.">PaginarPDO</a>($this-&gt;pdo, $sql, $sufijo);
<a name="l00509"></a>00509 
<a name="l00510"></a>00510          <span class="keywordflow">if</span> ( $pd-&gt;validar() ) {
<a name="l00511"></a>00511 
<a name="l00512"></a>00512             $gcm-&gt;event-&gt;anular(<span class="stringliteral">&#39;contenido_dinamico&#39;</span>,<span class="stringliteral">&#39;indexador&#39;</span>);
<a name="l00513"></a>00513 
<a name="l00514"></a>00514             $pd-&gt;elementos_pagina=$num;
<a name="l00515"></a>00515             $pd-&gt;plantilla_resultados=dirname(__FILE__).<span class="stringliteral">&#39;/../html/listado_contenido.html&#39;</span>;
<a name="l00516"></a>00516 
<a name="l00517"></a>00517             <span class="comment">// $pd-&gt;botonera();</span>
<a name="l00518"></a>00518             <span class="comment">// $pd-&gt;pagina();</span>
<a name="l00519"></a>00519             <span class="comment">// $pd-&gt;botonera();</span>
<a name="l00520"></a>00520             $pd-&gt;generar_pagina(<span class="stringliteral">&#39;&amp;formato=ajax&amp;m=indexador&amp;a=ultimas_entradas&#39;</span>);
<a name="l00521"></a>00521 
<a name="l00522"></a>00522          }
<a name="l00523"></a>00523 
<a name="l00524"></a>00524       } <span class="keywordflow">else</span> {
<a name="l00525"></a>00525 
<a name="l00526"></a>00526          <span class="comment">/* Formato para columna */</span>
<a name="l00527"></a>00527 
<a name="l00528"></a>00528          $sufijo = <span class="stringliteral">&#39;uecl_&#39;</span>; <span class="comment">// Sufijo para pajinador (ultimas entradas columna)</span>
<a name="l00529"></a>00529 
<a name="l00530"></a>00530          <span class="keywordflow">if</span> ( $estamos == <span class="stringliteral">&#39;inicio&#39;</span> || empty($seccion) ) {
<a name="l00531"></a>00531             $titulo=literal(<span class="stringliteral">&#39;Últimas entradas&#39;</span>);
<a name="l00532"></a>00532          } <span class="keywordflow">else</span> {
<a name="l00533"></a>00533             $titulo=literal(<span class="stringliteral">&#39;Últimas entradas en&#39;</span>,3).<span class="charliteral">&#39; &#39;</span>.$seccion_actual;
<a name="l00534"></a>00534             }
<a name="l00535"></a>00535 
<a name="l00536"></a>00536          $pd = <span class="keyword">new</span> <a class="code" href="../../d2/dee/a00049.html" title="Recogemos clase padre.">PaginarPDO</a>($this-&gt;pdo, $sql, $sufijo);
<a name="l00537"></a>00537 
<a name="l00538"></a>00538          <span class="keywordflow">if</span> ( $pd-&gt;validar() ) {
<a name="l00539"></a>00539 
<a name="l00540"></a>00540             $pd-&gt;plantilla_resultados=dirname(__FILE__).<span class="stringliteral">&#39;/../html/listado_columna.html&#39;</span>;
<a name="l00541"></a>00541             $pd-&gt;elementos_pagina=$num;
<a name="l00542"></a>00542             ob_start();
<a name="l00543"></a>00543             $pd-&gt;pagina();
<a name="l00544"></a>00544             $contenido = ob_get_contents();
<a name="l00545"></a>00545             ob_end_clean(); 
<a name="l00546"></a>00546 
<a name="l00547"></a>00547             $panel = array();
<a name="l00548"></a>00548             $panel[<span class="stringliteral">&#39;titulo&#39;</span>] = $titulo;
<a name="l00549"></a>00549             $panel[<span class="stringliteral">&#39;oculto&#39;</span>] = TRUE;
<a name="l00550"></a>00550             $panel[<span class="stringliteral">&#39;href&#39;</span>] = <a class="code" href="../../d9/d73/a00060_a1659f0a629d408e0f849dbe4ee061e62.html#a1659f0a629d408e0f849dbe4ee061e62" title="Base de url relativa al directorio.">Router::$dir</a>.<span class="stringliteral">&#39;indexador/ultimas_entradas/&#39;</span>.<a class="code" href="../../d9/d73/a00060_a50b05cf2e02ef0b67fcad97106dd7634.html#a50b05cf2e02ef0b67fcad97106dd7634" title="Sección.">Router::$s</a>;
<a name="l00551"></a>00551             $panel[<span class="stringliteral">&#39;subpanel&#39;</span>] =<span class="stringliteral">&#39;list_ultimas_entradas&#39;</span>;
<a name="l00552"></a>00552             $panel[<span class="stringliteral">&#39;contenido&#39;</span>] =$contenido;
<a name="l00553"></a>00553 
<a name="l00554"></a>00554             <a class="code" href="../../d9/db3/a00066_ad3facc2fb6a91bd685681984a3a19602.html#ad3facc2fb6a91bd685681984a3a19602" title="panel">Temas::panel</a>($panel);
<a name="l00555"></a>00555 
<a name="l00556"></a>00556             }
<a name="l00557"></a>00557          }
<a name="l00558"></a>00558 
<a name="l00559"></a>00559       }
<a name="l00560"></a>00560 <span class="comment"></span>
<a name="l00561"></a>00561 <span class="comment">   /**</span>
<a name="l00562"></a>00562 <span class="comment">    * @f</span>
<a name="l00563"></a>00563 <span class="comment">    * @brief borrar_archivo_pdo</span>
<a name="l00564"></a>00564 <span class="comment">    *</span>
<a name="l00565"></a>00565 <span class="comment">    * Eliminar entrada de un archivo en la base de datos</span>
<a name="l00566"></a>00566 <span class="comment">    *</span>
<a name="l00567"></a>00567 <span class="comment">    * @author Eduardo Magrané</span>
<a name="l00568"></a>00568 <span class="comment">    * @version 1.0</span>
<a name="l00569"></a>00569 <span class="comment">    *</span>
<a name="l00570"></a>00570 <span class="comment">    * @param url Url del archivo a eliminar</span>
<a name="l00571"></a>00571 <span class="comment">    *</span>
<a name="l00572"></a>00572 <span class="comment">    * @return TRUE/FALSE</span>
<a name="l00573"></a>00573 <span class="comment">    *</span>
<a name="l00574"></a>00574 <span class="comment">    */</span>
<a name="l00575"></a>00575 
<a name="l00576"></a><a class="code" href="../../d5/df9/a00044_ae4d6e695da2937b6032aa7c5cffd21e9.html#ae4d6e695da2937b6032aa7c5cffd21e9">00576</a>    <span class="keyword">function</span> <a class="code" href="../../d5/df9/a00044_ae4d6e695da2937b6032aa7c5cffd21e9.html#ae4d6e695da2937b6032aa7c5cffd21e9">borrar_archivo_pdo</a>($e, $args) {
<a name="l00577"></a>00577 
<a name="l00578"></a>00578       global <a class="code" href="../../d4/d63/a00082_a19a0c049e76bf73f0a16f04e31cfbe86.html#a19a0c049e76bf73f0a16f04e31cfbe86" title="Instancia de Gcm.">$gcm</a>; 
<a name="l00579"></a>00579 
<a name="l00580"></a>00580       $parametros = <a class="code" href="../../df/d98/a00107_a30a2aab875d1c34d154086ccfc7066e6.html#a30a2aab875d1c34d154086ccfc7066e6" title="Recogemos los argumentos entregados a una función y devolvemos un array con par valor.">recoger_parametros</a>($args);
<a name="l00581"></a>00581 
<a name="l00582"></a>00582       <span class="keywordflow">if</span> ( isset($parametros[<span class="stringliteral">&#39;url&#39;</span>]) ) {               <span class="comment">// Si tenemos url</span>
<a name="l00583"></a>00583          $urls = array($parametros[<span class="stringliteral">&#39;url&#39;</span>]) ;
<a name="l00584"></a>00584          $gcm-&gt;registra(__FILE__,__LINE__,<span class="stringliteral">&#39;Recibimos un archivo para borrar desde url [&#39;</span>.$url.<span class="charliteral">&#39;]&#39;</span>);
<a name="l00585"></a>00585       } elseif ( isset($parametros[<span class="stringliteral">&#39;ruta_origen&#39;</span>]) ) { <span class="comment">// Si tenemos una ruta origen por cambio de nombre</span>
<a name="l00586"></a>00586          $urls = array($parametros[<span class="stringliteral">&#39;ruta_origen&#39;</span>]) ;
<a name="l00587"></a>00587          $gcm-&gt;registra(__FILE__,__LINE__,<span class="stringliteral">&#39;Recibimos un archivo para borrar desde ruta_origen[&#39;</span>.$url.<span class="charliteral">&#39;]&#39;</span>);
<a name="l00588"></a>00588       } elseif ( isset($gcm-&gt;memoria[<span class="stringliteral">&#39;origen&#39;</span>]) ) { <span class="comment">// Si tenemos una ruta origen por cambio de nombre</span>
<a name="l00589"></a>00589          $urls = array($gcm-&gt;memoria[<span class="stringliteral">&#39;origen&#39;</span>]) ;
<a name="l00590"></a>00590          $gcm-&gt;registra(__FILE__,__LINE__,<span class="stringliteral">&#39;Recibimos un archivo para borrar desde gcm-&gt;memoria[origen] &#39;</span>.$urls[0]);
<a name="l00591"></a>00591       } elseif ( isset($_POST[<span class="stringliteral">&#39;seleccionado&#39;</span>]) ) {          <span class="comment">// Nos llegan los archivos borrados por POST[&#39;seccion&#39;]</span>
<a name="l00592"></a>00592          $gcm-&gt;registra(__FILE__,__LINE__,<span class="stringliteral">&#39;Recibimos lista rachivos a borrar desde POST[seleccionado]: &#39;</span>);
<a name="l00593"></a>00593          <span class="keywordflow">foreach</span> ( $_POST[<span class="stringliteral">&#39;seleccionado&#39;</span>] as $val ) {
<a name="l00594"></a>00594             $urls[]=stripslashes($val);
<a name="l00595"></a>00595             }
<a name="l00596"></a>00596       } <span class="keywordflow">else</span> {
<a name="l00597"></a>00597          $gcm-&gt;registra(__FILE__,__LINE__,<span class="stringliteral">&#39;Se necesita url de contenido para borrar&#39;</span>,<span class="stringliteral">&#39;ERROR&#39;</span>);
<a name="l00598"></a>00598          }
<a name="l00599"></a>00599 
<a name="l00600"></a>00600       <span class="keywordflow">foreach</span> ( $urls as $url ) {
<a name="l00601"></a>00601 
<a name="l00602"></a>00602          $url = <a class="code" href="../../d1/dc6/a00037_a7e948c6a92a0ac3ce31d296e9d44474b.html#a7e948c6a92a0ac3ce31d296e9d44474b" title="desglosar_url()">GUtil::desglosar_url</a>($url);
<a name="l00603"></a>00603 
<a name="l00604"></a>00604          $gcm-&gt;registra(__FILE__,__LINE__,<span class="stringliteral">&#39;Eliminamos archivo de la bd: &#39;</span>.$url);
<a name="l00605"></a>00605 
<a name="l00606"></a>00606          $SQL =  <span class="stringliteral">&quot;DELETE FROM &quot;</span>.$this-&gt;prefijo.<span class="stringliteral">&quot;archivos WHERE url=?&quot;</span>;
<a name="l00607"></a>00607 
<a name="l00608"></a>00608          <span class="keywordflow">if</span> ( $sqlResult = $this-&gt;pdo-&gt;prepare($SQL) ) {
<a name="l00609"></a>00609             <span class="keywordflow">if</span> ( $sqlResult-&gt;execute(array($url)) ) {
<a name="l00610"></a>00610                $gcm-&gt;registra(__FILE__,__LINE__,<span class="stringliteral">&#39;Eliminado de la base de datos [ &#39;</span>.$url.<span class="stringliteral">&#39; ]&#39;</span>);
<a name="l00611"></a>00611             } <span class="keywordflow">else</span> {
<a name="l00612"></a>00612                $gcm-&gt;registra(__FILE__,__LINE__,<span class="stringliteral">&#39;ERROR: Borrando archivo de la base de datos: [&#39;</span>.$url.<span class="stringliteral">&#39;]. &#39;</span>.$SQL,<span class="stringliteral">&#39;ERROR&#39;</span>);
<a name="l00613"></a>00613             }
<a name="l00614"></a>00614          } <span class="keywordflow">else</span> {
<a name="l00615"></a>00615 
<a name="l00616"></a>00616             $gcm-&gt;registra(__FILE__,__LINE__,<span class="stringliteral">&#39;No se pudo borrar de la base de datos [&#39;</span>.$url.<span class="charliteral">&#39;]&#39;</span>.<span class="stringliteral">&quot;\nsql: &quot;</span>.$SQL,<span class="stringliteral">&#39;ADMIN&#39;</span>);
<a name="l00617"></a>00617 
<a name="l00618"></a>00618             }
<a name="l00619"></a>00619          }
<a name="l00620"></a>00620 
<a name="l00621"></a>00621       <span class="keywordflow">return</span> TRUE;
<a name="l00622"></a>00622       }
<a name="l00623"></a>00623 <span class="comment"></span>
<a name="l00624"></a>00624 <span class="comment">   /**</span>
<a name="l00625"></a>00625 <span class="comment">    * gcm_borrar_tabla_pdo</span>
<a name="l00626"></a>00626 <span class="comment">    *</span>
<a name="l00627"></a>00627 <span class="comment">    * Eliminar una tabla de la base de datos</span>
<a name="l00628"></a>00628 <span class="comment">    *</span>
<a name="l00629"></a>00629 <span class="comment">    * @author Eduardo Magrané</span>
<a name="l00630"></a>00630 <span class="comment">    * @version 1.0</span>
<a name="l00631"></a>00631 <span class="comment">    *</span>
<a name="l00632"></a>00632 <span class="comment">    * @param tabla nombre de la tabla a eliminar</span>
<a name="l00633"></a>00633 <span class="comment">    *</span>
<a name="l00634"></a>00634 <span class="comment">    * @return TRUE/FALSE</span>
<a name="l00635"></a>00635 <span class="comment">    *</span>
<a name="l00636"></a>00636 <span class="comment">    */</span>
<a name="l00637"></a>00637 
<a name="l00638"></a><a class="code" href="../../d5/df9/a00044_a8d3aef75b4260695852ac05e04f26ff0.html#a8d3aef75b4260695852ac05e04f26ff0">00638</a>    <span class="keyword">function</span> <a class="code" href="../../d5/df9/a00044_a8d3aef75b4260695852ac05e04f26ff0.html#a8d3aef75b4260695852ac05e04f26ff0" title="gcm_borrar_tabla_pdo">gcm_borrar_tabla_pdo</a>($tabla) {
<a name="l00639"></a>00639 
<a name="l00640"></a>00640       global <a class="code" href="../../d4/d63/a00082_a19a0c049e76bf73f0a16f04e31cfbe86.html#a19a0c049e76bf73f0a16f04e31cfbe86" title="Instancia de Gcm.">$gcm</a>; 
<a name="l00641"></a>00641 
<a name="l00642"></a>00642       $gcm-&gt;registra(__FILE__,__LINE__,<span class="stringliteral">&#39;Eliminamos tabla de la bd: &#39;</span>.$tabla);
<a name="l00643"></a>00643 
<a name="l00644"></a>00644       $SQL =  <span class="stringliteral">&quot;DROP TABLE $tabla&quot;</span>;
<a name="l00645"></a>00645 
<a name="l00646"></a>00646       <span class="keywordflow">if</span> ( $sqlResult = $this-&gt;pdo-&gt;prepare($SQL) ) {
<a name="l00647"></a>00647          $sqlResult-&gt;execute();
<a name="l00648"></a>00648          <span class="keywordflow">return</span> TRUE;
<a name="l00649"></a>00649       } <span class="keywordflow">else</span> {
<a name="l00650"></a>00650 
<a name="l00651"></a>00651          <span class="keywordflow">if</span> ( $this-&gt;pdo_error) {
<a name="l00652"></a>00652             $gcm-&gt;registra(__FILE__,__LINE__,<span class="stringliteral">&quot;No se pudo borrar archivo de la base de datos&quot;</span>,<span class="stringliteral">&#39;ERROR&#39;</span>);
<a name="l00653"></a>00653             $gcm-&gt;registra(__FILE__,__LINE__,$this-&gt;pdo_error);
<a name="l00654"></a>00654             $gcm-&gt;registra(__FILE__,__LINE__,<span class="stringliteral">&quot;SQL::&quot;</span>.$SQL);
<a name="l00655"></a>00655             }
<a name="l00656"></a>00656 
<a name="l00657"></a>00657          <span class="keywordflow">return</span> FALSE;
<a name="l00658"></a>00658 
<a name="l00659"></a>00659          }
<a name="l00660"></a>00660 
<a name="l00661"></a>00661       }
<a name="l00662"></a>00662 <span class="comment"></span>
<a name="l00663"></a>00663 <span class="comment">   /** presentar_busquedas</span>
<a name="l00664"></a>00664 <span class="comment">    *</span>
<a name="l00665"></a>00665 <span class="comment">    * Presentamos los resultados.</span>
<a name="l00666"></a>00666 <span class="comment">    *</span>
<a name="l00667"></a>00667 <span class="comment">    * @see PaginarPDO.php</span>
<a name="l00668"></a>00668 <span class="comment">    *</span>
<a name="l00669"></a>00669 <span class="comment">    */</span>
<a name="l00670"></a>00670 
<a name="l00671"></a><a class="code" href="../../d5/df9/a00044_ae1643e0fd9e52392cf43df2b63e0923a.html#ae1643e0fd9e52392cf43df2b63e0923a">00671</a>    <span class="keyword">function</span> <a class="code" href="../../d5/df9/a00044_ae1643e0fd9e52392cf43df2b63e0923a.html#ae1643e0fd9e52392cf43df2b63e0923a" title="presentar_busquedas">presentar_busquedas</a>($e, $args) {
<a name="l00672"></a>00672 
<a name="l00673"></a>00673       global <a class="code" href="../../d4/d63/a00082_a19a0c049e76bf73f0a16f04e31cfbe86.html#a19a0c049e76bf73f0a16f04e31cfbe86" title="Instancia de Gcm.">$gcm</a>;
<a name="l00674"></a>00674 
<a name="l00675"></a>00675       $this-&gt;<a class="code" href="../../d4/dca/a00048_afde3a8df6c433ad68cc593072e489a92.html#afde3a8df6c433ad68cc593072e489a92" title="Añadir archivos javascript a la lista de Gcm.">javascripts</a>(<span class="stringliteral">&#39;indexador.js&#39;</span>);
<a name="l00676"></a>00676 
<a name="l00677"></a>00677       <span class="keywordflow">if</span> ( isset($_REQUEST[<span class="stringliteral">&#39;buscar&#39;</span>]) ) {
<a name="l00678"></a>00678          $palabras = explode(<span class="charliteral">&#39; &#39;</span>,$_REQUEST[<span class="stringliteral">&#39;buscar&#39;</span>]);
<a name="l00679"></a>00679       } <span class="keywordflow">else</span> {
<a name="l00680"></a>00680          $palabras = <a class="code" href="../../d9/d73/a00060_a67e94494731d99ed23b123e95175bc10.html#a67e94494731d99ed23b123e95175bc10" title="Array con argumentos pasados mediante url como ejemplo:">Router::$args</a>;
<a name="l00681"></a>00681          }
<a name="l00682"></a>00682 
<a name="l00683"></a>00683       $gcm-&gt;registra(__FILE__,__LINE__,<span class="stringliteral">&quot;Buscando &quot;</span>.<a class="code" href="../../df/d98/a00107_a7031d9d8dc6290aa33d665d7daced6c8.html#a7031d9d8dc6290aa33d665d7daced6c8" title="Formatemaos salida de array.">depurar</a>($palabras));
<a name="l00684"></a>00684 
<a name="l00685"></a>00685       <span class="keywordflow">if</span> ( !empty($palabras) ) {
<a name="l00686"></a>00686 
<a name="l00687"></a>00687          $CONDICION = <span class="stringliteral">&quot;&quot;</span>;
<a name="l00688"></a>00688          $ORDER = <span class="stringliteral">&quot; fecha_actualizacion_in desc &quot;</span>;
<a name="l00689"></a>00689          $conta = 0;
<a name="l00690"></a>00690          $fin = count($palabras);
<a name="l00691"></a>00691          <span class="keywordflow">foreach</span> ( $palabras as $pal ) {
<a name="l00692"></a>00692             <span class="comment">// Seguridad, evitar sqlinjection</span>
<a name="l00693"></a>00693             <span class="keywordflow">if</span> ( get_magic_quotes_gpc() ) {
<a name="l00694"></a>00694                $pal = stripslashes($pal);
<a name="l00695"></a>00695                }
<a name="l00696"></a>00696             $pal = addslashes($pal);
<a name="l00697"></a>00697             $pal = str_replace(<span class="charliteral">&#39;&quot;&#39;</span>,<span class="stringliteral">&#39;&#39;</span>,$pal); <span class="comment">// Eliminamos &quot; para que no de error</span>
<a name="l00698"></a>00698 
<a name="l00699"></a>00699             <span class="keywordflow">if</span> ( $conta != 0 ) {
<a name="l00700"></a>00700                $CONDICION .= <span class="stringliteral">&#39; OR &#39;</span>;
<a name="l00701"></a>00701                }
<a name="l00702"></a>00702             $CONDICION .= <span class="stringliteral">&quot; ( nombre like &#39;%&quot;</span>.$pal.<span class="stringliteral">&quot;%&#39; OR descripcion like &#39;%&quot;</span>.$pal.<span class="stringliteral">&quot;%&#39; ) &quot;</span>;
<a name="l00703"></a>00703             $conta++;
<a name="l00704"></a>00704             }
<a name="l00705"></a>00705 
<a name="l00706"></a>00706          require_once(GCM_DIR.<span class="stringliteral">&#39;lib/int/GcmPDO/lib/paginarPDO.php&#39;</span>);
<a name="l00707"></a>00707 
<a name="l00708"></a>00708          <span class="comment">/* Título de página */</span>
<a name="l00709"></a>00709 
<a name="l00710"></a>00710          $gcm-&gt;titulo = literal(<span class="stringliteral">&#39;Busqueda para&#39;</span>).<span class="stringliteral">&#39;: &lt;i&gt;&#39;</span>.implode(<span class="charliteral">&#39; &#39;</span>,$palabras).<span class="stringliteral">&#39;&lt;/i&gt;&#39;</span>;
<a name="l00711"></a>00711          $gcm-&gt;event-&gt;anular(<span class="stringliteral">&#39;titulo&#39;</span>,<span class="stringliteral">&#39;Indexador&#39;</span>);
<a name="l00712"></a>00712 
<a name="l00713"></a>00713          $sql = <span class="stringliteral">&quot;SELECT nombre, url, descripcion, fecha_actualizacion_in, fecha_creacion_at FROM &quot;</span>.$this-&gt;prefijo.<span class="stringliteral">&quot;archivos WHERE $CONDICION ORDER BY fecha_actualizacion_in desc &quot;</span>;
<a name="l00714"></a>00714 
<a name="l00715"></a>00715          $pd = <span class="keyword">new</span> <a class="code" href="../../d2/dee/a00049.html" title="Recogemos clase padre.">PaginarPDO</a>($this-&gt;pdo, $sql);
<a name="l00716"></a>00716 
<a name="l00717"></a>00717          <span class="keywordflow">if</span> ( $pd-&gt;validar() ) {
<a name="l00718"></a>00718 
<a name="l00719"></a>00719             <span class="keywordflow">if</span> ( $pd-&gt;numero_registros() == 1  ) {
<a name="l00720"></a>00720 
<a name="l00721"></a>00721                $gcm-&gt;registra(__FILE__,__LINE__,literal(<span class="stringliteral">&#39;Solo hubo un resultado, se presenta&#39;</span>),<span class="stringliteral">&#39;AVISO&#39;</span>);
<a name="l00722"></a>00722                <span class="keywordflow">while</span> ( $fila = $pd-&gt;to_array() ) {
<a name="l00723"></a>00723                   $url = <a class="code" href="../../d1/dc6/a00037_abecb97d888e136c231ff6f2c21d777a5.html#abecb97d888e136c231ff6f2c21d777a5" title="generar url valida">GUtil::gcm_generar_url</a>($fila[0][<span class="stringliteral">&#39;url&#39;</span>]);
<a name="l00724"></a>00724                   header (<span class="stringliteral">&quot;Location:&quot;</span>.$url.<span class="stringliteral">&#39;?mens=&#39;</span>.$gcm-&gt;reg-&gt;sesion);
<a name="l00725"></a>00725                   exit();
<a name="l00726"></a>00726                   }
<a name="l00727"></a>00727 
<a name="l00728"></a>00728             } <span class="keywordflow">else</span> {
<a name="l00729"></a>00729                
<a name="l00730"></a>00730                $gcm-&gt;event-&gt;anular(<span class="stringliteral">&#39;contenido_dinamico&#39;</span>,<span class="stringliteral">&#39;Indexador&#39;</span>);
<a name="l00731"></a>00731 
<a name="l00732"></a>00732                $pd-&gt;url_base = <span class="stringliteral">&#39;?e=buscar&amp;buscar=&#39;</span>.htmlentities(implode(<span class="charliteral">&#39;+&#39;</span>,$palabras));
<a name="l00733"></a>00733                $pd-&gt;elementos_pagina=8;
<a name="l00734"></a>00734                $pd-&gt;plantilla_resultados=dirname(__FILE__).<span class="stringliteral">&#39;/../html/listado_contenido.html&#39;</span>;
<a name="l00735"></a>00735 
<a name="l00736"></a>00736                $pd-&gt;botonera();
<a name="l00737"></a>00737                $pd-&gt;pagina();
<a name="l00738"></a>00738                $pd-&gt;botonera();
<a name="l00739"></a>00739 
<a name="l00740"></a>00740                }
<a name="l00741"></a>00741          } <span class="keywordflow">else</span> {
<a name="l00742"></a>00742             $gcm-&gt;registra(__FILE__,__LINE__,literal(<span class="stringliteral">&#39;No hubo resultados dentro del contenido &lt;b&gt;&#39;</span>.implode(<span class="charliteral">&#39; &#39;</span>,$palabras)).<span class="stringliteral">&#39;&lt;/b&gt;&#39;</span>,<span class="stringliteral">&#39;AVISO&#39;</span>);
<a name="l00743"></a>00743             }
<a name="l00744"></a>00744       } <span class="keywordflow">else</span> {
<a name="l00745"></a>00745          registrar(__FILE__,__LINE__,<span class="stringliteral">&#39;Indexador-&gt;presentar_resultados() Sin contenido a buscar&#39;</span>);
<a name="l00746"></a>00746          }
<a name="l00747"></a>00747 
<a name="l00748"></a>00748       }
<a name="l00749"></a>00749 <span class="comment"></span>
<a name="l00750"></a>00750 <span class="comment">   /**</span>
<a name="l00751"></a>00751 <span class="comment">    * En caso de no tener página de sección presentamos</span>
<a name="l00752"></a>00752 <span class="comment">    * ultimos elementos</span>
<a name="l00753"></a>00753 <span class="comment">    */</span>
<a name="l00754"></a>00754 
<a name="l00755"></a><a class="code" href="../../d5/df9/a00044_a13adafeed5d9cd678b1f9769a38c011e.html#a13adafeed5d9cd678b1f9769a38c011e">00755</a>    <span class="keyword">function</span> <a class="code" href="../../d5/df9/a00044_a13adafeed5d9cd678b1f9769a38c011e.html#a13adafeed5d9cd678b1f9769a38c011e" title="En caso de no tener página de sección presentamos ultimos elementos.">contenido_dinamico</a>() {
<a name="l00756"></a>00756 
<a name="l00757"></a>00757       global <a class="code" href="../../d4/d63/a00082_a19a0c049e76bf73f0a16f04e31cfbe86.html#a19a0c049e76bf73f0a16f04e31cfbe86" title="Instancia de Gcm.">$gcm</a>;
<a name="l00758"></a>00758 
<a name="l00759"></a>00759       <span class="comment">/* Comprobamos que no este anulado el evento contenido */</span>
<a name="l00760"></a>00760 
<a name="l00761"></a>00761       <span class="keywordflow">if</span> ( $gcm-&gt;event-&gt;anulado(<span class="stringliteral">&#39;contenido&#39;</span>) ) {
<a name="l00762"></a>00762          <span class="keywordflow">return</span>;
<a name="l00763"></a>00763          }
<a name="l00764"></a>00764 
<a name="l00765"></a>00765       $this-&gt;<a class="code" href="../../d4/dca/a00048_afde3a8df6c433ad68cc593072e489a92.html#afde3a8df6c433ad68cc593072e489a92" title="Añadir archivos javascript a la lista de Gcm.">javascripts</a>(<span class="stringliteral">&#39;indexador.js&#39;</span>);
<a name="l00766"></a>00766 
<a name="l00767"></a>00767       <span class="comment">// Por defecto</span>
<a name="l00768"></a>00768       $num_items_df = 5;
<a name="l00769"></a>00769       $secccion_df = <a class="code" href="../../d9/d73/a00060_a50b05cf2e02ef0b67fcad97106dd7634.html#a50b05cf2e02ef0b67fcad97106dd7634" title="Sección.">Router::$s</a>; <span class="comment">// Sección actual</span>
<a name="l00770"></a>00770       $formato_df = 0; <span class="comment">// Listado</span>
<a name="l00771"></a>00771 
<a name="l00772"></a>00772       $parametros = <a class="code" href="../../df/d98/a00107_a30a2aab875d1c34d154086ccfc7066e6.html#a30a2aab875d1c34d154086ccfc7066e6" title="Recogemos los argumentos entregados a una función y devolvemos un array con par valor.">recoger_parametros</a>(func_get_args());
<a name="l00773"></a>00773 
<a name="l00774"></a>00774       $num = ( isset($parametros[<span class="stringliteral">&#39;num&#39;</span>]) ) ? $parametros[<span class="stringliteral">&#39;num&#39;</span>] : $num_items_df ;
<a name="l00775"></a>00775       $seccion = ( isset($parametros[<span class="stringliteral">&#39;seccion&#39;</span>]) ) ? $parametros[<span class="stringliteral">&#39;seccion&#39;</span>] : $secccion_df ;
<a name="l00776"></a>00776       $formato = ( isset($parametros[<span class="stringliteral">&#39;formato&#39;</span>]) ) ? $parametros[<span class="stringliteral">&#39;formato&#39;</span>] : $formato_df ;
<a name="l00777"></a>00777 
<a name="l00778"></a>00778       $this-&gt;<a class="code" href="../../d5/df9/a00044_ad8635978c25709ea90addc47c5d695cb.html#ad8635978c25709ea90addc47c5d695cb" title="ultimas_entradas">ultimas_entradas</a>(NULL,<span class="stringliteral">&#39;num=&#39;</span>.$num.<span class="stringliteral">&#39;&amp;seccion=&#39;</span>.$seccion.<span class="stringliteral">&#39;&amp;formato=&#39;</span>.$formato);
<a name="l00779"></a>00779 
<a name="l00780"></a>00780       }
<a name="l00781"></a>00781 <span class="comment"></span>
<a name="l00782"></a>00782 <span class="comment">   /** gcm_indexar_paginas</span>
<a name="l00783"></a>00783 <span class="comment">    *</span>
<a name="l00784"></a>00784 <span class="comment">    * Imprimir listado de contenidos para indexar</span>
<a name="l00785"></a>00785 <span class="comment">    *</span>
<a name="l00786"></a>00786 <span class="comment">    * @param contenido Es un array con el listado de los archivos a indexar</span>
<a name="l00787"></a>00787 <span class="comment">    *</span>
<a name="l00788"></a>00788 <span class="comment">    * @return TRUE/FALSE</span>
<a name="l00789"></a>00789 <span class="comment">    *</span>
<a name="l00790"></a>00790 <span class="comment">    */</span>
<a name="l00791"></a>00791 
<a name="l00792"></a><a class="code" href="../../d5/df9/a00044_a0ce0b3221523e7b27775ee8b8345dd98.html#a0ce0b3221523e7b27775ee8b8345dd98">00792</a>    <span class="keyword">function</span> <a class="code" href="../../d5/df9/a00044_a0ce0b3221523e7b27775ee8b8345dd98.html#a0ce0b3221523e7b27775ee8b8345dd98" title="gcm_indexar_paginas">gcm_indexar_paginas</a>($contenido) {
<a name="l00793"></a>00793 
<a name="l00794"></a>00794       global <a class="code" href="../../d4/d63/a00082_a19a0c049e76bf73f0a16f04e31cfbe86.html#a19a0c049e76bf73f0a16f04e31cfbe86" title="Instancia de Gcm.">$gcm</a>;
<a name="l00795"></a>00795 
<a name="l00796"></a>00796       $funcion_js_indexar = <span class="stringliteral">&#39;indexar&#39;</span>;
<a name="l00797"></a>00797 
<a name="l00798"></a>00798       <span class="keywordflow">foreach</span> ( $contenido as $item =&gt; $elemento ) {
<a name="l00799"></a>00799 
<a name="l00800"></a>00800          <span class="keywordflow">if</span> ( is_array($elemento) ) {                             <span class="comment">// si elemento es un array es un directorio</span>
<a name="l00801"></a>00801 
<a name="l00802"></a>00802             $nombre = basename($item);
<a name="l00803"></a>00803             <span class="keywordflow">if</span> (  $nombre[0] != <span class="charliteral">&#39;.&#39;</span> ) {                         <span class="comment">// No es un directorio oculto</span>
<a name="l00804"></a>00804                $this-&gt;<a class="code" href="../../d5/df9/a00044_a0ce0b3221523e7b27775ee8b8345dd98.html#a0ce0b3221523e7b27775ee8b8345dd98" title="gcm_indexar_paginas">gcm_indexar_paginas</a>($elemento);
<a name="l00805"></a>00805                }
<a name="l00806"></a>00806 
<a name="l00807"></a>00807          } elseif ( !<a class="code" href="../../df/d98/a00107_ad4691c145a42085229f6da545f5aeee7.html#ad4691c145a42085229f6da545f5aeee7" title="esImagen">esImagen</a>($elemento) &amp;&amp; substr_count($elemento,<span class="stringliteral">&#39;.html&#39;</span>) &gt; 0 ) { <span class="comment">// comprobamos que sea un archivo html</span>
<a name="l00808"></a>00808 
<a name="l00809"></a>00809             $nombre = basename($elemento);
<a name="l00810"></a>00810             <span class="keywordflow">if</span> ( $nombre[0] != <span class="charliteral">&#39;.&#39;</span> ) { <span class="comment">// No es un fichero oculto</span>
<a name="l00811"></a>00811 
<a name="l00812"></a>00812                $camino = <a class="code" href="../../d1/dc6/a00037_a3936e0f973a073482cf1999d5d992fcb.html#a3936e0f973a073482cf1999d5d992fcb" title="camino">GUtil::camino</a>($elemento);
<a name="l00813"></a>00813 
<a name="l00814"></a>00814                include($gcm-&gt;event-&gt;instancias[<span class="stringliteral">&#39;temas&#39;</span>]-&gt;ruta(<span class="stringliteral">&#39;indexador&#39;</span>,<span class="stringliteral">&#39;html&#39;</span>,<span class="stringliteral">&#39;elemento_lista_indexar.html&#39;</span>));
<a name="l00815"></a>00815                }
<a name="l00816"></a>00816 
<a name="l00817"></a>00817             }
<a name="l00818"></a>00818          }
<a name="l00819"></a>00819       <span class="keywordflow">return</span> TRUE;
<a name="l00820"></a>00820 
<a name="l00821"></a>00821       }
<a name="l00822"></a>00822 
<a name="l00823"></a>00823 <span class="comment"></span>
<a name="l00824"></a>00824 <span class="comment">   /** indexado() </span>
<a name="l00825"></a>00825 <span class="comment">    *</span>
<a name="l00826"></a>00826 <span class="comment">    * indexamos Router::$f</span>
<a name="l00827"></a>00827 <span class="comment">    *</span>
<a name="l00828"></a>00828 <span class="comment">    * Esta función nos sirve para hacer un indexado por ajax</span>
<a name="l00829"></a>00829 <span class="comment">    * o no.</span>
<a name="l00830"></a>00830 <span class="comment">    */</span>
<a name="l00831"></a>00831 
<a name="l00832"></a><a class="code" href="../../d5/df9/a00044_aab75a59b1e44cc46eff7d07334f80a1b.html#aab75a59b1e44cc46eff7d07334f80a1b">00832</a>    <span class="keyword">function</span> <a class="code" href="../../d5/df9/a00044_aab75a59b1e44cc46eff7d07334f80a1b.html#aab75a59b1e44cc46eff7d07334f80a1b" title="indexado()">indexado</a>() {
<a name="l00833"></a>00833 
<a name="l00834"></a>00834       global <a class="code" href="../../d4/d63/a00082_a19a0c049e76bf73f0a16f04e31cfbe86.html#a19a0c049e76bf73f0a16f04e31cfbe86" title="Instancia de Gcm.">$gcm</a>;
<a name="l00835"></a>00835 
<a name="l00836"></a>00836       <span class="keywordflow">if</span> ( $this-&gt;<a class="code" href="../../d5/df9/a00044_a775a6bedde0982bd9a393dbc15d65f42.html#a775a6bedde0982bd9a393dbc15d65f42" title="indexar_archivo_pdo">indexar_archivo_pdo</a>(<span class="stringliteral">&#39;indexado&#39;</span>,<a class="code" href="../../d9/d73/a00060_a23c42e7d231a63025b55e4eb7e3d4c99.html#a23c42e7d231a63025b55e4eb7e3d4c99" title="Url del contenido que se pide.">Router::$f</a>) !== FALSE ) {
<a name="l00837"></a>00837          $salida = <span class="stringliteral">&quot;Contenido reindexado&quot;</span>;
<a name="l00838"></a>00838       } <span class="keywordflow">else</span> {
<a name="l00839"></a>00839          $salida  = <span class="stringliteral">&#39;&lt;p class=&quot;error&quot;&gt;&#39;</span>;
<a name="l00840"></a>00840          $salida .= <span class="stringliteral">&#39;Error al indexar contenido&#39;</span>;
<a name="l00841"></a>00841          $salida .= <span class="stringliteral">&#39;&lt;/p&gt;&#39;</span>;
<a name="l00842"></a>00842          }
<a name="l00843"></a>00843 
<a name="l00844"></a>00844       <span class="keywordflow">if</span> ( <a class="code" href="../../d9/d73/a00060_a5972ce25233a2f1fcd6d68a139b28f71.html#a5972ce25233a2f1fcd6d68a139b28f71" title="Formato de presentación, ejemplo html, ajax, rss, etc...">Router::$formato</a> == <span class="stringliteral">&#39;ajax&#39;</span>  ) {
<a name="l00845"></a>00845          echo $salida;
<a name="l00846"></a>00846       } <span class="keywordflow">else</span> {
<a name="l00847"></a>00847          registrar(__FILE__,__LINE__,$salida,<span class="stringliteral">&#39;AVISO&#39;</span>);
<a name="l00848"></a>00848          }
<a name="l00849"></a>00849 
<a name="l00850"></a>00850       }
<a name="l00851"></a>00851 <span class="comment"></span>
<a name="l00852"></a>00852 <span class="comment">   /**</span>
<a name="l00853"></a>00853 <span class="comment">    * Reindexado completo</span>
<a name="l00854"></a>00854 <span class="comment">    *</span>
<a name="l00855"></a>00855 <span class="comment">    * EL reindexado completo borra las tablas para volver a generarlas y ejecuta</span>
<a name="l00856"></a>00856 <span class="comment">    * reindexado de las paginas encontradas una a una con ajax para no tener </span>
<a name="l00857"></a>00857 <span class="comment">    * problemas con el tiempo de ejecución del servidor</span>
<a name="l00858"></a>00858 <span class="comment">    */</span>
<a name="l00859"></a>00859 
<a name="l00860"></a><a class="code" href="../../d5/df9/a00044_a6cbdc21b9a0613970009ed23ad13c9c7.html#a6cbdc21b9a0613970009ed23ad13c9c7">00860</a>    <span class="keyword">function</span> <a class="code" href="../../d5/df9/a00044_a6cbdc21b9a0613970009ed23ad13c9c7.html#a6cbdc21b9a0613970009ed23ad13c9c7" title="Reindexado completo.">reindexado_completo</a>($e, $args=NULL) {
<a name="l00861"></a>00861 
<a name="l00862"></a>00862       global <a class="code" href="../../d4/d63/a00082_a19a0c049e76bf73f0a16f04e31cfbe86.html#a19a0c049e76bf73f0a16f04e31cfbe86" title="Instancia de Gcm.">$gcm</a>;
<a name="l00863"></a>00863 
<a name="l00864"></a>00864       $this-&gt;<a class="code" href="../../d4/dca/a00048_afde3a8df6c433ad68cc593072e489a92.html#afde3a8df6c433ad68cc593072e489a92" title="Añadir archivos javascript a la lista de Gcm.">javascripts</a>(<span class="stringliteral">&#39;listado_reindexado.js&#39;</span>);
<a name="l00865"></a>00865       $this-&gt;<a class="code" href="../../d4/dca/a00048_afde3a8df6c433ad68cc593072e489a92.html#afde3a8df6c433ad68cc593072e489a92" title="Añadir archivos javascript a la lista de Gcm.">javascripts</a>(<span class="stringliteral">&#39;reindexador_completo.js&#39;</span>);
<a name="l00866"></a>00866 
<a name="l00867"></a>00867       $gcm-&gt;event-&gt;anular(<span class="stringliteral">&#39;contenido&#39;</span>,<span class="stringliteral">&#39;indexador&#39;</span>);
<a name="l00868"></a>00868       $gcm-&gt;event-&gt;anular(<span class="stringliteral">&#39;titulo&#39;</span>,<span class="stringliteral">&#39;indexador&#39;</span>);
<a name="l00869"></a>00869       $gcm-&gt;presentar_contenido_dinamico = FALSE;
<a name="l00870"></a>00870 
<a name="l00871"></a>00871       $gcm-&gt;titulo = literal(<span class="stringliteral">&#39;Reindexar contenido&#39;</span>);
<a name="l00872"></a>00872 
<a name="l00873"></a>00873       <span class="comment">// Indexamos</span>
<a name="l00874"></a>00874       $contenido = <a class="code" href="../../df/d98/a00107_a4dc3ef6e1713aa9b0711bcdbe682cd91.html#a4dc3ef6e1713aa9b0711bcdbe682cd91" title="Devolver el contenido de un directorio en un array.">dir_array</a>(<span class="stringliteral">&#39;File/&#39;</span>.<a class="code" href="../../d9/d73/a00060_a088fc18ad150c02f45bb46c5dc472aa9.html#a088fc18ad150c02f45bb46c5dc472aa9" title="Idioma por defecto.">Router::$ii</a>, $this-&gt;descartar) ;
<a name="l00875"></a>00875 
<a name="l00876"></a>00876       <span class="comment">// Borrar tablas</span>
<a name="l00877"></a>00877       <a class="code" href="../../df/d98/a00107_a04137b8be9893e1592ac0e3dc9af072c.html#a04137b8be9893e1592ac0e3dc9af072c" title="Borrar tabla.">borrar_tabla</a>($this-&gt;pdo,$this-&gt;prefijo.<span class="stringliteral">&#39;archivos&#39;</span>);
<a name="l00878"></a>00878       <a class="code" href="../../df/d98/a00107_a04137b8be9893e1592ac0e3dc9af072c.html#a04137b8be9893e1592ac0e3dc9af072c" title="Borrar tabla.">borrar_tabla</a>($this-&gt;pdo,$this-&gt;prefijo.<span class="stringliteral">&#39;etiquetas&#39;</span>);
<a name="l00879"></a>00879       <a class="code" href="../../df/d98/a00107_a04137b8be9893e1592ac0e3dc9af072c.html#a04137b8be9893e1592ac0e3dc9af072c" title="Borrar tabla.">borrar_tabla</a>($this-&gt;pdo,$this-&gt;prefijo.<span class="stringliteral">&#39;r_etiqueta_archivo&#39;</span>);
<a name="l00880"></a>00880       $this-&gt;<a class="code" href="../../d5/df9/a00044_a267bfb8d6746e1d698abef3c25ec162c.html#a267bfb8d6746e1d698abef3c25ec162c" title="Generar tablas.">generar_tablas</a>();
<a name="l00881"></a>00881 
<a name="l00882"></a>00882       $this-&gt;<a class="code" href="../../d5/df9/a00044_a47929172e490db6b2a04acbd7ecbf499.html#a47929172e490db6b2a04acbd7ecbf499" title="Presentar contenidos para reindexar.">lista_contenido_reindexar</a>();
<a name="l00883"></a>00883 
<a name="l00884"></a>00884       }
<a name="l00885"></a>00885 <span class="comment"></span>
<a name="l00886"></a>00886 <span class="comment">   /**</span>
<a name="l00887"></a>00887 <span class="comment">    * Presentar contenidos para reindexar</span>
<a name="l00888"></a>00888 <span class="comment">    *</span>
<a name="l00889"></a>00889 <span class="comment">    * Creamos lista de contenido a reindexar</span>
<a name="l00890"></a>00890 <span class="comment">    */</span>
<a name="l00891"></a>00891 
<a name="l00892"></a><a class="code" href="../../d5/df9/a00044_a47929172e490db6b2a04acbd7ecbf499.html#a47929172e490db6b2a04acbd7ecbf499">00892</a>    <span class="keyword">function</span> <a class="code" href="../../d5/df9/a00044_a47929172e490db6b2a04acbd7ecbf499.html#a47929172e490db6b2a04acbd7ecbf499" title="Presentar contenidos para reindexar.">lista_contenido_reindexar</a>() {
<a name="l00893"></a>00893 
<a name="l00894"></a>00894       <span class="comment">// Indexamos</span>
<a name="l00895"></a>00895       $contenido = <a class="code" href="../../df/d98/a00107_a4dc3ef6e1713aa9b0711bcdbe682cd91.html#a4dc3ef6e1713aa9b0711bcdbe682cd91" title="Devolver el contenido de un directorio en un array.">dir_array</a>(<span class="stringliteral">&#39;File/&#39;</span>.<a class="code" href="../../d9/d73/a00060_a088fc18ad150c02f45bb46c5dc472aa9.html#a088fc18ad150c02f45bb46c5dc472aa9" title="Idioma por defecto.">Router::$ii</a>, $this-&gt;descartar) ;
<a name="l00896"></a>00896 
<a name="l00897"></a>00897       echo <span class="stringliteral">&quot;\n&quot;</span>,<span class="stringliteral">&#39;&lt;div style=&quot;display: none;&quot; class=&quot;error&quot; id=&quot;errores_reindexando&quot;&gt;&lt;/div&gt;&#39;</span>;
<a name="l00898"></a>00898 
<a name="l00899"></a>00899       echo <span class="stringliteral">&quot;\n&quot;</span>.<span class="stringliteral">&#39;&lt;div id=&quot;panel_indexado&quot;&gt;Indexados: 0&lt;/div&gt;&#39;</span>;
<a name="l00900"></a>00900       echo <span class="stringliteral">&quot;\n&quot;</span>.<span class="stringliteral">&#39;&lt;div id=&quot;listado_reindexar&quot;&gt;&#39;</span>;
<a name="l00901"></a>00901 
<a name="l00902"></a>00902       <span class="keywordflow">if</span> ( !$this-&gt;<a class="code" href="../../d5/df9/a00044_a0ce0b3221523e7b27775ee8b8345dd98.html#a0ce0b3221523e7b27775ee8b8345dd98" title="gcm_indexar_paginas">gcm_indexar_paginas</a>($contenido) ) {
<a name="l00903"></a>00903          trigger_error(literal(<span class="stringliteral">&#39;Error&#39;</span>).<span class="charliteral">&#39; &#39;</span>.literal(<span class="stringliteral">&#39;No se pudo reindexar&#39;</span>), E_USER_ERROR);
<a name="l00904"></a>00904          }
<a name="l00905"></a>00905 
<a name="l00906"></a>00906       echo <span class="stringliteral">&quot;\n&quot;</span>.<span class="stringliteral">&#39;&lt;/div&gt; &lt;!-- listado_reindexar --&gt;&#39;</span>;
<a name="l00907"></a>00907 
<a name="l00908"></a>00908       }
<a name="l00909"></a>00909 <span class="comment"></span>
<a name="l00910"></a>00910 <span class="comment">   /** </span>
<a name="l00911"></a>00911 <span class="comment">    * reindexamos contenido</span>
<a name="l00912"></a>00912 <span class="comment">    *</span>
<a name="l00913"></a>00913 <span class="comment">    * Presentamos listado de contenido con boton para reindexar.</span>
<a name="l00914"></a>00914 <span class="comment">    *</span>
<a name="l00915"></a>00915 <span class="comment">    * Ejecutando cada reindexado individualmente con ajax para que el servidor </span>
<a name="l00916"></a>00916 <span class="comment">    * no nos de problema con el tiempo de ejecución del script.</span>
<a name="l00917"></a>00917 <span class="comment">    *</span>
<a name="l00918"></a>00918 <span class="comment">    */</span>
<a name="l00919"></a>00919 
<a name="l00920"></a><a class="code" href="../../d5/df9/a00044_a1f3b1307e446c231365e2bef5e611fbc.html#a1f3b1307e446c231365e2bef5e611fbc">00920</a>    <span class="keyword">function</span> <a class="code" href="../../d5/df9/a00044_a1f3b1307e446c231365e2bef5e611fbc.html#a1f3b1307e446c231365e2bef5e611fbc" title="reindexamos contenido">reindexar</a>($e, $args=NULL) {
<a name="l00921"></a>00921 
<a name="l00922"></a>00922       global <a class="code" href="../../d4/d63/a00082_a19a0c049e76bf73f0a16f04e31cfbe86.html#a19a0c049e76bf73f0a16f04e31cfbe86" title="Instancia de Gcm.">$gcm</a>;
<a name="l00923"></a>00923 
<a name="l00924"></a>00924       $this-&gt;<a class="code" href="../../d4/dca/a00048_afde3a8df6c433ad68cc593072e489a92.html#afde3a8df6c433ad68cc593072e489a92" title="Añadir archivos javascript a la lista de Gcm.">javascripts</a>(<span class="stringliteral">&#39;listado_reindexado.js&#39;</span>);
<a name="l00925"></a>00925 
<a name="l00926"></a>00926       $gcm-&gt;event-&gt;anular(<span class="stringliteral">&#39;contenido&#39;</span>,<span class="stringliteral">&#39;indexador&#39;</span>);
<a name="l00927"></a>00927       $gcm-&gt;event-&gt;anular(<span class="stringliteral">&#39;titulo&#39;</span>,<span class="stringliteral">&#39;indexador&#39;</span>);
<a name="l00928"></a>00928       $gcm-&gt;presentar_contenido_dinamico = FALSE;
<a name="l00929"></a>00929 
<a name="l00930"></a>00930       $gcm-&gt;titulo = literal(<span class="stringliteral">&#39;Reindexar contenido&#39;</span>);
<a name="l00931"></a>00931 
<a name="l00932"></a>00932       echo <span class="stringliteral">&quot;\n&lt;br /&gt;&quot;</span>;
<a name="l00933"></a>00933       echo <span class="stringliteral">&quot;\n&lt;br /&gt;Directorios descartados de reindexado&quot;</span>;
<a name="l00934"></a>00934       echo <span class="stringliteral">&quot;\n&lt;ul&gt;&quot;</span>;
<a name="l00935"></a>00935       <span class="keywordflow">foreach</span> ($this-&gt;descartar as $descartado) echo <span class="stringliteral">&quot;&lt;li&gt;&quot;</span>.$descartado.<span class="stringliteral">&quot;&lt;/li&gt;&quot;</span>;
<a name="l00936"></a>00936       echo <span class="stringliteral">&quot;\n&lt;/ul&gt;&quot;</span>;
<a name="l00937"></a>00937       echo <span class="stringliteral">&quot;\nTamaño descripción: &lt;b&gt;&quot;</span>.$this-&gt;maxLong.<span class="stringliteral">&quot;&lt;/b&gt;&quot;</span>;
<a name="l00938"></a>00938       echo <span class="stringliteral">&quot;\n&lt;br /&gt;&quot;</span>;
<a name="l00939"></a>00939       echo <span class="stringliteral">&quot;\n&lt;br /&gt;&quot;</span>,<span class="stringliteral">&#39;&lt;span class=&quot;boton&quot;&gt;&lt;a href=&quot;&#39;</span>.Router::$base.<span class="stringliteral">&#39;?e=reindexado_completo&quot; &gt;Ejecutar reindexado completo&lt;/a&gt;&lt;/span&gt;&#39;</span>;
<a name="l00940"></a>00940       echo <span class="stringliteral">&#39;&lt;br /&gt;&lt;br /&gt;&#39;</span>;
<a name="l00941"></a>00941 
<a name="l00942"></a>00942       $this-&gt;<a class="code" href="../../d5/df9/a00044_a47929172e490db6b2a04acbd7ecbf499.html#a47929172e490db6b2a04acbd7ecbf499" title="Presentar contenidos para reindexar.">lista_contenido_reindexar</a>($e,$args);
<a name="l00943"></a>00943 
<a name="l00944"></a>00944       }
<a name="l00945"></a>00945 <span class="comment"></span>
<a name="l00946"></a>00946 <span class="comment">   /** Indexar contenido</span>
<a name="l00947"></a>00947 <span class="comment">    *</span>
<a name="l00948"></a>00948 <span class="comment">    * Indexamos contenido especificado</span>
<a name="l00949"></a>00949 <span class="comment">    */</span>
<a name="l00950"></a>00950 
<a name="l00951"></a><a class="code" href="../../d5/df9/a00044_a1a0acfedadd86e6aa79c7eec1383eeb1.html#a1a0acfedadd86e6aa79c7eec1383eeb1">00951</a>    <span class="keyword">function</span> <a class="code" href="../../d5/df9/a00044_a1a0acfedadd86e6aa79c7eec1383eeb1.html#a1a0acfedadd86e6aa79c7eec1383eeb1" title="Indexar contenido.">indexar_contenido</a>($e,$args) {
<a name="l00952"></a>00952 
<a name="l00953"></a>00953       global <a class="code" href="../../d4/d63/a00082_a19a0c049e76bf73f0a16f04e31cfbe86.html#a19a0c049e76bf73f0a16f04e31cfbe86" title="Instancia de Gcm.">$gcm</a>;
<a name="l00954"></a>00954 
<a name="l00955"></a>00955       <span class="keywordflow">if</span> ( $this-&gt;<a class="code" href="../../d5/df9/a00044_a775a6bedde0982bd9a393dbc15d65f42.html#a775a6bedde0982bd9a393dbc15d65f42" title="indexar_archivo_pdo">indexar_archivo_pdo</a>(<span class="stringliteral">&#39;indexar_contenido&#39;</span>,<a class="code" href="../../d9/d73/a00060_a23c42e7d231a63025b55e4eb7e3d4c99.html#a23c42e7d231a63025b55e4eb7e3d4c99" title="Url del contenido que se pide.">Router::$f</a>) === FALSE ) {
<a name="l00956"></a>00956          $gcm-&gt;registra(__FILE__,__LINE__,<span class="stringliteral">&#39;Error al indexar [&#39;</span>.<a class="code" href="../../d9/d73/a00060_a23c42e7d231a63025b55e4eb7e3d4c99.html#a23c42e7d231a63025b55e4eb7e3d4c99" title="Url del contenido que se pide.">Router::$f</a>.<span class="charliteral">&#39;]&#39;</span>,<span class="stringliteral">&#39;ERROR&#39;</span>);
<a name="l00957"></a>00957          }
<a name="l00958"></a>00958 
<a name="l00959"></a>00959       }
<a name="l00960"></a>00960 <span class="comment"></span>
<a name="l00961"></a>00961 <span class="comment">   /**</span>
<a name="l00962"></a>00962 <span class="comment">    * Cambio de nombre de una sección</span>
<a name="l00963"></a>00963 <span class="comment">    *</span>
<a name="l00964"></a>00964 <span class="comment">    * @param $e Evento recibido</span>
<a name="l00965"></a>00965 <span class="comment">    * @param $args Argumentos extras si los hay</span>
<a name="l00966"></a>00966 <span class="comment">    */</span>
<a name="l00967"></a>00967 
<a name="l00968"></a><a class="code" href="../../d5/df9/a00044_a16bea5fad987af5020d6a768595a7764.html#a16bea5fad987af5020d6a768595a7764">00968</a>    <span class="keyword">function</span> <a class="code" href="../../d5/df9/a00044_a16bea5fad987af5020d6a768595a7764.html#a16bea5fad987af5020d6a768595a7764" title="Cambio de nombre de una sección.">cambio_ruta_seccion</a>($e, $args=NULL) {
<a name="l00969"></a>00969 
<a name="l00970"></a>00970       $seccion = ( $_POST[<span class="stringliteral">&#39;seleccionado&#39;</span>][0] ) ? $_POST[<span class="stringliteral">&#39;seleccionado&#39;</span>][0] : <span class="stringliteral">&#39;&#39;</span>; 
<a name="l00971"></a>00971       $seccion = <a class="code" href="../../df/d98/a00107_a6ab4ae106b6ebf5769bc3390aa8ac287.html#a6ab4ae106b6ebf5769bc3390aa8ac287" title="comprobar_barra()">comprobar_barra</a>($seccion).$_POST[<span class="stringliteral">&#39;nuevo_nombre&#39;</span>];
<a name="l00972"></a>00972 
<a name="l00973"></a>00973       <span class="keywordflow">if</span> ( empty($seccion) ) {
<a name="l00974"></a>00974          registrar(__FILE__,__LINE__,<span class="stringliteral">&#39;Sin sección para seleccionada para renombrar&#39;</span>,<span class="stringliteral">&#39;ERROR&#39;</span>);
<a name="l00975"></a>00975          <span class="keywordflow">return</span> FALSE;
<a name="l00976"></a>00976          }
<a name="l00977"></a>00977 
<a name="l00978"></a>00978       <span class="comment">// Limpiar nombre de sección</span>
<a name="l00979"></a>00979       $ruta_destino=<a class="code" href="../../d1/dc6/a00037_a1bc35227366d73c2bc2017c66d1076f2.html#a1bc35227366d73c2bc2017c66d1076f2" title="Para evitar guardar los nombres de los ficheros con acentos y otras cosas que pueda producir que no f...">GUtil::textoplano</a>($seccion);
<a name="l00980"></a>00980       $ruta_destino=str_replace(<a class="code" href="../../d9/d73/a00060_a53c89bcf51a9d61cb1c76b91e42aac4e.html#a53c89bcf51a9d61cb1c76b91e42aac4e" title="Directorio con idioma por defecto.">Router::$dd</a>,<span class="stringliteral">&#39;&#39;</span>,$ruta_destino);
<a name="l00981"></a>00981       $ruta_origen = <a class="code" href="../../d9/d73/a00060_a50b05cf2e02ef0b67fcad97106dd7634.html#a50b05cf2e02ef0b67fcad97106dd7634" title="Sección.">Router::$s</a>;
<a name="l00982"></a>00982 
<a name="l00983"></a>00983       $sql = <span class="stringliteral">&quot;SELECT id, url FROM &quot;</span>.$this-&gt;prefijo.<span class="stringliteral">&quot;archivos WHERE url like &#39;%&quot;</span>.$ruta_origen.<span class="stringliteral">&quot;%&#39;&quot;</span>;
<a name="l00984"></a>00984       $result = $this-&gt;pdo-&gt;query($sql);
<a name="l00985"></a>00985       $num_afectados = $result-&gt;fetchColumn();
<a name="l00986"></a>00986 
<a name="l00987"></a>00987       registrar(__FILE__,__LINE__,<span class="stringliteral">&#39;Modificar url [ &#39;</span>.$ruta_origen.<span class="stringliteral">&#39; ] por [ &#39;</span>.$ruta_destino.<span class="stringliteral">&#39; ], afectados: [ &#39;</span>.$num_afectados.<span class="stringliteral">&#39; ]&#39;</span>);
<a name="l00988"></a>00988 
<a name="l00989"></a>00989       <span class="keywordflow">if</span> ( $num_afectados &gt; 0 ) {
<a name="l00990"></a>00990 
<a name="l00991"></a>00991          <span class="keywordflow">if</span> ( $sqlResult = $this-&gt;pdo-&gt;prepare($sql) ) {
<a name="l00992"></a>00992 
<a name="l00993"></a>00993             $sqlResult-&gt;execute();
<a name="l00994"></a>00994 
<a name="l00995"></a>00995             <span class="keywordflow">while</span>($fila = $sqlResult-&gt;fetch(PDO::FETCH_OBJ)) {
<a name="l00996"></a>00996 
<a name="l00997"></a>00997                $nueva_ruta = str_replace($ruta_origen,$ruta_destino.<span class="charliteral">&#39;/&#39;</span>,$fila-&gt;url);
<a name="l00998"></a>00998                $subsql=<span class="stringliteral">&quot;UPDATE &quot;</span>.$this-&gt;prefijo.<span class="stringliteral">&quot;archivos SET url=? WHERE id=?&quot;</span>;
<a name="l00999"></a>00999                $subresult = $this-&gt;pdo-&gt;prepare($subsql);
<a name="l01000"></a>01000                <span class="keywordflow">if</span> ( $subresult-&gt;execute(array($nueva_ruta,$fila-&gt;id)) ) {
<a name="l01001"></a>01001                   registrar(__FILE__,__LINE__,<span class="stringliteral">&#39;Modificada url de sección [ &#39;</span>.$nueva_ruta.<span class="stringliteral">&#39; ]&#39;</span>);
<a name="l01002"></a>01002                } <span class="keywordflow">else</span> {
<a name="l01003"></a>01003                   registrar(__FILE__,__LINE__,<span class="stringliteral">&#39;Sin resultados para [&#39;</span>.$nueva_ruta.<span class="charliteral">&#39;]&#39;</span>,<span class="stringliteral">&#39;ERROR&#39;</span>);
<a name="l01004"></a>01004                   }
<a name="l01005"></a>01005 
<a name="l01006"></a>01006                }
<a name="l01007"></a>01007 
<a name="l01008"></a>01008             } 
<a name="l01009"></a>01009 
<a name="l01010"></a>01010          }
<a name="l01011"></a>01011 
<a name="l01012"></a>01012       }
<a name="l01013"></a>01013 
<a name="l01014"></a>01014    }
<a name="l01015"></a>01015 ?&gt;
</pre></div></div><!-- contents -->


<hr class="footer"/><address class="footer"><small>
Generado el Miércoles, 3 de Abril de 2013 09:33:13 para gcm por &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="../../doxygen.png" alt="doxygen"/>
</a> 1.8.0
</small></address>

</body>
</html>
